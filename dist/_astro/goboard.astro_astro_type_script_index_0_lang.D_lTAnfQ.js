const U=()=>{document.querySelectorAll(".go-app").forEach(f=>{if(f.getAttribute("data-initialized"))return;const S=f.querySelector(".goBoard"),N=f.querySelector(".status"),O=f.getAttribute("data-teacher")==="true",o=S.getContext("2d",{alpha:!1});if(!o)return;let l=9;const E=2,z=500;let v=30*E,A=O?"SETUP":"SOLVE",n=[],u="black",L="",P="black",b={children:[]},a=b,m=[],y={x:-1,y:-1},B=!1;(()=>{S.width=z*E,S.height=z*E})();const T=t=>{n=Array(t).fill(0).map(()=>Array(t).fill(null))},C=f.getAttribute("data-problem");if(C)try{const t=JSON.parse(C);if(l=t.size||9,T(l),t.turn?u=t.turn:u="black",t.initialState){L=t.initialState;const e=JSON.parse(t.initialState);Array.isArray(e)&&(Array.isArray(e[0])?n=e:e.forEach(r=>{r&&r.x!==void 0&&(n[r.x][r.y]={color:r.color})}))}if(t.solution)if(Array.isArray(t.solution)){let e=b;t.solution.forEach(r=>{const i={...r,children:[],status:null};e.children.push(i),e=i}),e.status="correct"}else b=t.solution;a=b,O||(A="SOLVE")}catch(t){console.error(t)}else T(l);const I=t=>{l=t,T(l),b={children:[]},a=b,m=[],L="",u="black",document.querySelectorAll(".size-btn").forEach(e=>{e.getAttribute("data-size")==t?e.classList.add("active"):e.classList.remove("active")}),w(),k(`${l}x${l} Tahta Hazır`,"#fff")};O&&f.querySelectorAll(".size-btn").forEach(t=>{t.addEventListener("click",e=>{const r=parseInt(e.target.getAttribute("data-size")||"9");I(r)})});const R=(t,e)=>t>=0&&t<l&&e>=0&&e<l,p=(t,e,r,i=new Set)=>{const s=`${t},${e}`;if(i.has(s))return 0;i.add(s);let h=0;return[[t+1,e],[t-1,e],[t,e+1],[t,e-1]].forEach(([d,g])=>{if(!R(d,g))return;const J=n[d][g];J?J.color===r&&(h+=p(d,g,r,i)):h++}),h},M=(t,e,r)=>{const i=n[t][e];if(!i||i.color!==r)return;n[t][e]=null,[[t+1,e],[t-1,e],[t,e+1],[t,e-1]].forEach(([h,c])=>{R(h,c)&&M(h,c,r)})},q=(t,e,r)=>{if(n[t][e])return!1;n[t][e]={color:r};let i=!1;const s=r==="black"?"white":"black";return[[t+1,e],[t-1,e],[t,e+1],[t,e-1]].forEach(([c,d])=>{R(c,d)&&n[c][d]&&n[c][d].color===s&&p(c,d,s)===0&&(M(c,d,s),i=!0)}),!i&&p(t,e,r)===0?(n[t][e]=null,k("İntihar hamlesi yasak!","#e74c3c"),!1):!0},w=()=>{o.fillStyle="#eebb66",o.fillRect(0,0,S.width,S.height);const t=(S.width-v*2)/(l-1);o.lineWidth=1.5*E,o.strokeStyle="#000",o.beginPath();for(let r=0;r<l;r++){const i=Math.round(v+r*t);o.moveTo(i,v),o.lineTo(i,S.height-v),o.moveTo(v,i),o.lineTo(S.width-v,i),o.fillStyle="#000",o.font=`bold ${12*E}px sans-serif`,o.textAlign="center",o.textBaseline="middle";const s=String.fromCharCode(65+(r>=8?r+1:r));o.fillText(s,i,S.height-10*E),o.fillText((l-r).toString(),15*E,i)}o.stroke();const e=l===19?[3,9,15]:l===13?[3,6,9]:[2,4,6];l>=9&&(o.fillStyle="#000",e.forEach(r=>{e.forEach(i=>{o.beginPath(),o.arc(v+r*t,v+i*t,3*E,0,Math.PI*2),o.fill()})})),n.forEach((r,i)=>r.forEach((s,h)=>{s&&D(i,h,s.color,t,1)})),y.x>=0&&y.x<l&&y.y>=0&&y.y<l&&(n[y.x][y.y]||D(y.x,y.y,u,t,.5))},D=(t,e,r,i,s)=>{const h=v+t*i,c=v+e*i,d=i*.48;if(o.save(),o.globalAlpha=s,s===1&&(o.shadowColor="rgba(0,0,0,0.3)",o.shadowBlur=3*E,o.shadowOffsetX=1*E,o.shadowOffsetY=1*E),o.beginPath(),o.arc(h,c,d,0,Math.PI*2),r==="black"){const g=o.createRadialGradient(h-d*.3,c-d*.3,d*.1,h,c,d);g.addColorStop(0,"#555"),g.addColorStop(1,"#000"),o.fillStyle=g}else{const g=o.createRadialGradient(h-d*.3,c-d*.3,d*.1,h,c,d);g.addColorStop(0,"#fff"),g.addColorStop(1,"#ddd"),o.fillStyle=g}o.fill(),r==="white"&&s===1&&(o.lineWidth=1,o.strokeStyle="#ccc",o.stroke()),o.restore()};S.addEventListener("mousemove",t=>{if(A==="SOLVE"&&B){S.style.cursor="default";return}const e=S.getBoundingClientRect(),r=S.width/e.width,i=S.height/e.height,s=(t.clientX-e.left)*r-v,h=(t.clientY-e.top)*i-v,c=(S.width-v*2)/(l-1),d=Math.round(s/c),g=Math.round(h/c);d>=0&&d<l&&g>=0&&g<l?(y.x!==d||y.y!==g)&&(y={x:d,y:g},S.style.cursor="pointer",w()):y.x!==-1&&(y={x:-1,y:-1},S.style.cursor="default",w())}),S.addEventListener("mouseleave",()=>{y={x:-1,y:-1},w()}),S.addEventListener("click",t=>{if(A==="SOLVE"&&B){k("Tekrar denemek için 'Yenile' butonuna basın.","#e74c3c");return}if(y.x===-1)return;const e=y.x,r=y.y;if(A==="SETUP")n[e][r]=n[e][r]&&n[e][r].color===u?null:{color:u},w();else if(A==="RECORD"){if(n[e][r])return;const i=JSON.stringify(n),s=u;if(!q(e,r,u))return;let h=a.children.find(c=>c.x===e&&c.y===r);if(h)m.push({node:a,stonesSnapshot:i,turn:s}),a=h,k("Mevcut dalda ilerlendi.","#3498db");else{const c={x:e,y:r,color:u,children:[],status:null};a.children.push(c),m.push({node:a,stonesSnapshot:i,turn:s}),a=c,k("Yeni varyasyon kaydediliyor...","#f1c40f")}u=u==="black"?"white":"black",w()}else if(A==="SOLVE"){const i=a.children.find(s=>s.x===e&&s.y===r);i?(q(e,r,i.color),a=i,u=u==="black"?"white":"black",w(),Y(a),a.children.length>0&&!a.status&&setTimeout(()=>{const s=a.children[0];q(s.x,s.y,s.color),a=s,u=u==="black"?"white":"black",w(),Y(a)},500)):(k("Tanımsız hamle. (Yanlış olabilir)","#e74c3c"),B=!0,f.classList.add("locked"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!1))}});function Y(t){t.status==="correct"?(k("Tebrikler! Doğru Çözüm.","#2ecc71"),B=!0,f.classList.add("locked"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!0),typeof window.unlockNextButton=="function"&&window.unlockNextButton()):t.status==="wrong"&&(k("Yanlış yol! (Yenile butonuna basınız)","#e74c3c"),B=!0,f.classList.add("locked"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!1))}function k(t,e){N&&(N.innerText=t,N.style.color=e)}if(O){f.querySelector("#undoBtn")?.addEventListener("click",()=>{if(m.length>0){const e=m.pop();a=e.node,n=JSON.parse(e.stonesSnapshot),u=e.turn,k("Geri alındı.","#fff"),w()}}),f.querySelector("#markCorrectBtn")?.addEventListener("click",()=>{a!==b&&(a.status="correct",k("Bu dal 'DOĞRU' işaretlendi.","#2ecc71"))}),f.querySelector("#markWrongBtn")?.addEventListener("click",()=>{a!==b&&(a.status="wrong",k("Bu dal 'YANLIŞ' işaretlendi.","#e74c3c"))}),f.querySelector(".setupBtn")?.addEventListener("click",()=>x("SETUP")),f.querySelector(".recordBtn")?.addEventListener("click",()=>x("RECORD")),f.querySelector(".exportBtn")?.addEventListener("click",()=>{const e={id:`prob-${Date.now()}`,size:l,turn:P,initialState:L||JSON.stringify(n),solution:b};console.log(JSON.stringify(e,null,2)),alert("Ağaç yapısı (Tree) Console'a yazdırıldı!")});const t=f.querySelector(".colorToggleBtn");t&&t.addEventListener("click",()=>{u=u==="black"?"white":"black";const e=document.getElementById("teacherColorIndicator");e&&(e.classList.toggle("black"),e.classList.toggle("white"))})}const x=t=>{if(t==="SETUP"){if(L){const e=JSON.parse(L);Array.isArray(e)&&Array.isArray(e[0])&&(n=e),b={children:[]},a=b,m=[]}k("Taşları dizin.","#fff")}t==="RECORD"&&A==="SETUP"&&(L=JSON.stringify(n),P=u,b={children:[]},a=b,m=[],k("Kayıt Başladı.","#f1c40f")),A=t,f.querySelectorAll(".control-btn").forEach(e=>e.classList.remove("active")),t==="SETUP"&&f.querySelector(".setupBtn")?.classList.add("active"),t==="RECORD"&&f.querySelector(".recordBtn")?.classList.add("active")};f.querySelector(".resetBtn")?.addEventListener("click",()=>{if(k("","#fff"),B=!1,f.classList.remove("locked"),O&&A==="SETUP")T(l);else{const t=C?JSON.parse(C):{};if(t.turn?u=t.turn:u="black",L){const e=JSON.parse(L);Array.isArray(e)&&Array.isArray(e[0])?n=e:(T(l),Array.isArray(e)&&e.forEach(r=>{r&&(n[r.x][r.y]={color:r.color})}))}else T(l);a=b,m=[]}w()}),window.resetAllBoards||(window.resetAllBoards=()=>{document.querySelectorAll(".resetBtn").forEach(e=>{e instanceof HTMLElement&&e.click()})}),f.setAttribute("data-initialized","true"),w()})};document.addEventListener("astro:page-load",U);document.addEventListener("DOMContentLoaded",U);
