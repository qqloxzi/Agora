const G=()=>{document.querySelectorAll(".go-app").forEach(Q=>{const f=Q;if(f.getAttribute("data-initialized"))return;const u=f.querySelector(".goBoard"),D=f.querySelector(".status"),T=f.getAttribute("data-teacher")==="true",z=f.getAttribute("data-joseki")==="true";if(!u)return;const o=u.getContext("2d",{alpha:!0});if(!o)return;let s=19;const A=3,X=800;let y=35*A,w=T?"SETUP":"SOLVE",M=[],E=[],J=!1,I=1,n=[],c="black",B="",K="black",v={children:[]},a=v,O=[],N=null,m=!1,S={x:-1,y:-1},C=!1;(()=>{u&&(u.width=X*A,u.height=X*A)})();const q=e=>{n=Array(e).fill(0).map(()=>Array(e).fill(null)),E=Array(e).fill(0).map(()=>Array(e).fill(null))},U=()=>{window.dispatchEvent(new CustomEvent("unlock-next-problem"));let e=0;const t=setInterval(()=>{e++;const r=document.querySelectorAll('#nextBtn, .next-problem-btn, [data-action="next"]');let l=!1;r.forEach(i=>{i instanceof HTMLElement&&(i.removeAttribute("disabled"),i.style.opacity="1",i.style.pointerEvents="auto",i.style.cursor="pointer",i.classList.remove("disabled","opacity-50","pointer-events-none","cursor-not-allowed"),i.style.display="",l=!0)}),(l||e>10)&&clearInterval(t)},100);try{typeof window.handleMoveResult=="function"&&window.handleMoveResult(!0)}catch{}};function h(e,t){D&&(D.innerText=e,D.style.color=t)}const R=f.getAttribute("data-problem");if(R)try{const e=JSON.parse(R);if(s=e.size||19,q(s),e.labels&&(E=typeof e.labels=="string"?JSON.parse(e.labels):e.labels),e.turn?c=e.turn:c="black",e.initialState){B=e.initialState;const t=JSON.parse(e.initialState);Array.isArray(t)&&(Array.isArray(t[0])?n=t:t.forEach(r=>{r&&r.x!==void 0&&(n[r.x][r.y]={color:r.color})}))}if(e.solution)if(Array.isArray(e.solution))if(e.solution.length>0){let t=v;e.solution.forEach(r=>{const l={...r,children:[],status:null};t.children.push(l),t=l}),t.status="correct",m=!0}else m=!1;else e.solution.children&&e.solution.children.length>0?(v=e.solution,m=!0):m=!1;else m=!1;a=v,T||(w="SOLVE")}catch(e){console.error(e)}else q(s),m=!1;!T&&!m&&!z?setTimeout(()=>{h("Analiz Modu (Cevap gerekmez)","#3498db"),U()},100):z&&setTimeout(()=>{h("Joseki Keşif Modu","#f1c40f")},100);const Z=e=>{s=e,q(s),v={children:[]},a=v,O=[],B="",c="black",N=null,document.querySelectorAll(".size-btn").forEach(t=>{t.getAttribute("data-size")==e.toString()?t.classList.add("active"):t.classList.remove("active")}),g(),h(`${s}x${s} Tahta Hazır`,"#fff")};T&&f.querySelectorAll(".size-btn").forEach(e=>{e.addEventListener("click",t=>{const r=t.target,l=parseInt(r.getAttribute("data-size")||"19");Z(l)})});const Y=(e,t)=>e>=0&&e<s&&t>=0&&t<s,$=(e,t,r,l=new Set)=>{const i=`${e},${t}`;if(l.has(i))return 0;l.add(i);let d=0;return[[e+1,t],[e-1,t],[e,t+1],[e,t-1]].forEach(([k,b])=>{if(!Y(k,b))return;const L=n[k][b];L?L.color===r&&(d+=$(k,b,r,l)):d++}),d},H=(e,t,r)=>{const l=n[e][t];if(!l||l.color!==r)return;n[e][t]=null,[[e+1,t],[e-1,t],[e,t+1],[e,t-1]].forEach(([d,p])=>{Y(d,p)&&H(d,p,r)})},x=(e,t,r)=>{if(n[e][t])return!1;const l=JSON.stringify(n);n[e][t]={color:r};let i=!1;const d=r==="black"?"white":"black";if([[e+1,t],[e-1,t],[e,t+1],[e,t-1]].forEach(([b,L])=>{Y(b,L)&&n[b][L]&&n[b][L].color===d&&$(b,L,d)===0&&(H(b,L,d),i=!0)}),!i&&$(e,t,r)===0)return n=JSON.parse(l),h("İntihar hamlesi yasak!","#e74c3c"),!1;const k=JSON.stringify(n);return M.length>0&&M[M.length-1]===k?(n=JSON.parse(l),h("Ko Kuralı!","#e74c3c"),!1):(M.push(l),M.length>2&&M.shift(),N={x:e,y:t},!0)},g=()=>{if(!u)return;o.clearRect(0,0,u.width,u.height);const e=(u.width-y*2)/(s-1);o.lineWidth=1*A,o.strokeStyle="#000",o.beginPath();for(let l=0;l<s;l++){const i=Math.round(y+l*e);o.moveTo(i,y),o.lineTo(i,u.height-y),o.moveTo(y,i),o.lineTo(u.width-y,i)}o.stroke(),o.fillStyle="#000",o.font=`${10*A}px sans-serif`,o.textAlign="center",o.textBaseline="middle";const t=y/1.5;for(let l=0;l<s;l++){const i=Math.round(y+l*e),d=String.fromCharCode(65+(l>=8?l+1:l));o.fillText(d,i,u.height-t);const p=(s-l).toString();o.fillText(p,u.width-t,i)}const r=s===19?[3,9,15]:s===13?[3,6,9]:[2,4,6];s>=9&&(o.fillStyle="#000",r.forEach(l=>{r.forEach(i=>{o.beginPath(),o.arc(y+l*e,y+i*e,2*A,0,Math.PI*2),o.fill()})})),o.fillStyle="#000",o.font=`bold ${e*.5}px sans-serif`,o.textAlign="center",o.textBaseline="middle";for(let l=0;l<s;l++)for(let i=0;i<s;i++)if(E[l][i]){const d=y+l*e,p=y+i*e;o.fillText(E[l][i],d,p)}n.forEach((l,i)=>l.forEach((d,p)=>{d&&V(i,p,d.color,e,1,!1)})),z&&a.children&&a.children.length>0&&a.children.forEach(l=>{n[l.x][l.y]||V(l.x,l.y,l.color,e,.4,!0)}),!C&&S.x>=0&&S.x<s&&S.y>=0&&S.y<s&&(n[S.x][S.y]||V(S.x,S.y,c,e,.5,!1))},V=(e,t,r,l,i,d)=>{const p=y+e*l,k=y+t*l,b=l*.48;o.save(),o.globalAlpha=i,N&&N.x===e&&N.y===t&&i===1?(o.shadowColor="#3498db",o.shadowBlur=15*A):d&&(o.shadowColor=r==="black"?"#000":"#fff",o.shadowBlur=10*A),o.beginPath(),o.arc(p,k,b,0,Math.PI*2),o.fillStyle=r==="black"?"#000":"#fff",o.fill(),r==="white"&&(o.lineWidth=.8*A,o.strokeStyle="#000",o.stroke()),d&&(o.fillStyle=r==="black"?"rgba(255,255,255,0.5)":"rgba(0,0,0,0.5)",o.beginPath(),o.arc(p,k,b*.3,0,Math.PI*2),o.fill()),o.restore()};u.addEventListener("mousemove",e=>{if(w==="SOLVE"&&C){u.style.cursor="default";return}const t=u.getBoundingClientRect(),r=u.width/t.width,l=u.height/t.height,i=(e.clientX-t.left)*r-y,d=(e.clientY-t.top)*l-y,p=(u.width-y*2)/(s-1),k=Math.round(i/p),b=Math.round(d/p);k>=0&&k<s&&b>=0&&b<s?(S.x!==k||S.y!==b)&&(S={x:k,y:b},u.style.cursor="pointer",g()):S.x!==-1&&(S={x:-1,y:-1},u.style.cursor="default",g())}),u.addEventListener("mouseleave",()=>{S={x:-1,y:-1},g()}),u.addEventListener("click",e=>{if(w==="SOLVE"&&C){h("Tekrar denemek için 'Yenile' butonuna basın.","#e74c3c");return}if(S.x===-1)return;const t=S.x,r=S.y;if(J){E[t][r]?E[t][r]=null:E[t][r]=I++,g();return}if(w==="SETUP")n[t][r]=n[t][r]&&n[t][r].color===c?null:{color:c},g();else if(w==="RECORD"){if(n[t][r])return;const l=JSON.stringify(n),i=c;if(!x(t,r,c))return;let d=a.children.find(p=>p.x===t&&p.y===r);if(d)O.push({node:a,stonesSnapshot:l,turn:i}),a=d,h("Mevcut dalda ilerlendi.","#3498db");else{const p={x:t,y:r,color:c,children:[],status:null};a.children.push(p),O.push({node:a,stonesSnapshot:l,turn:i}),a=p,h("Yeni varyasyon kaydediliyor...","#f1c40f")}c=c==="black"?"white":"black",g()}else if(w==="SOLVE"){const l=a.children.find(i=>i.x===t&&i.y===r);if(z){l?(x(t,r,l.color),a=l,c=l.color==="black"?"white":"black",h("Varyasyon seçildi.","#2ecc71"),g()):m||x(t,r,c)&&(c=c==="black"?"white":"black",g());return}if(!m){x(t,r,c)&&(c=c==="black"?"white":"black",g(),h("Analiz Modu","#3498db"));return}l?(x(t,r,l.color),a=l,c=c==="black"?"white":"black",g(),W(a),a.children&&a.children.length>0&&!a.status&&setTimeout(()=>{const i=a.children[0];x(i.x,i.y,i.color),a=i,c=c==="black"?"white":"black",g(),W(a)},500)):(h("Tanımsız hamle.","#e74c3c"),C=!0,f.classList.add("locked"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!1))}});function W(e){if(e.status==="correct"){j();return}if(e.status==="wrong"){_();return}(!e.children||e.children.length===0)&&j()}function j(){h("Tebrikler! Doğru Çözüm.","#2ecc71"),C=!0,f.classList.add("locked"),U()}function _(){h("Yanlış yol!","#e74c3c"),C=!0,f.classList.add("locked"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!1)}if(T){f.querySelector("#undoBtn")?.addEventListener("click",()=>{if(O.length>0){const t=O.pop();t&&(a=t.node,n=JSON.parse(t.stonesSnapshot),c=t.turn,N=null,h("Geri alındı.","#fff"),g())}}),f.querySelector("#markCorrectBtn")?.addEventListener("click",()=>{a!==v&&(a.status="correct",h("Bu dal 'DOĞRU' işaretlendi.","#2ecc71"))}),f.querySelector("#markWrongBtn")?.addEventListener("click",()=>{a!==v&&(a.status="wrong",h("Bu dal 'YANLIŞ' işaretlendi.","#e74c3c"))}),f.querySelector(".setupBtn")?.addEventListener("click",()=>F("SETUP")),f.querySelector(".recordBtn")?.addEventListener("click",()=>F("RECORD")),f.querySelector(".exportBtn")?.addEventListener("click",()=>{const t=prompt("Soru Başlığı:","Yeni Soru")||"İsimsiz",r={id:`prob-${Date.now()}`,size:s,labels:JSON.stringify(E),turn:K,title:t,initialState:B||JSON.stringify(n),solution:v};console.log(JSON.stringify(r,null,2)),alert("Veri console'a yazıldı.")});const e=f.querySelector(".colorToggleBtn");e&&e.addEventListener("click",()=>{c=c==="black"?"white":"black";const t=document.getElementById("teacherColorIndicator");t&&(t.classList.toggle("black"),t.classList.toggle("white"))})}const F=e=>{if(e==="SETUP"){if(B){const t=JSON.parse(B);Array.isArray(t)&&Array.isArray(t[0])&&(n=t),v={children:[]},a=v,O=[]}h("Taşları dizin.","#fff")}e==="RECORD"&&w==="SETUP"&&(B=JSON.stringify(n),K=c,v={children:[]},a=v,O=[],h("Kayıt Başladı.","#f1c40f")),w=e,f.querySelectorAll(".control-btn").forEach(t=>t.classList.remove("active")),e==="SETUP"&&f.querySelector(".setupBtn")?.classList.add("active"),e==="RECORD"&&f.querySelector(".recordBtn")?.classList.add("active")};f.querySelector(".resetBtn")?.addEventListener("click",()=>{if(h("","#fff"),C=!1,f.classList.remove("locked"),E=Array(s).fill(0).map(()=>Array(s).fill(null)),I=1,J=!1,f.querySelector(".labelBtn")?.classList.remove("active"),M=[],N=null,T&&w==="SETUP")q(s);else{const e=R?JSON.parse(R):{};if(e.turn?c=e.turn:c="black",B){const t=JSON.parse(B);Array.isArray(t)&&Array.isArray(t[0])?n=t:(q(s),Array.isArray(t)&&t.forEach(r=>{r&&(n[r.x][r.y]={color:r.color})}))}else q(s);e.labels&&(E=typeof e.labels=="string"?JSON.parse(e.labels):e.labels),a=v,O=[],!T&&!m&&(h(z?"Joseki Modu":"Analiz Modu","#3498db"),U())}g()});const P=f.querySelector(".labelBtn");P&&P.addEventListener("click",()=>{J=!J,J?(P.classList.add("active"),h(`Etiket: ${I}`,"#000")):(P.classList.remove("active"),h("Mod kapatıldı.","#fff"))}),window.resetAllBoards||(window.resetAllBoards=()=>{document.querySelectorAll(".resetBtn").forEach(e=>e.click())}),f.setAttribute("data-initialized","true"),g()})};document.addEventListener("astro:page-load",G);document.addEventListener("DOMContentLoaded",G);
