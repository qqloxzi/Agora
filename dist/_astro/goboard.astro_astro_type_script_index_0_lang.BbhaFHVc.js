const M=new Audio("/sounds/stone.mp3");M.volume=.8;const Q=()=>{document.querySelectorAll(".go-app").forEach(Z=>{const f=Z;if(f.getAttribute("data-initialized"))return;const d=f.querySelector(".goBoard"),R=f.querySelector(".coords-layer"),$=f.querySelector(".status");if(!d)return;const L=f.getAttribute("data-teacher")==="true",o=d.getContext("2d",{alpha:!1});if(!o)return;let a=9;const w=window.devicePixelRatio||2,D=1e3;let y=0,A=L?"SETUP":"SOLVE",i=[],z=[],T=[],h="black",B="",I="black",k={children:[]},p=k,x=[],O=!1,g={x:-1,y:-1},C=!1,b=null;const U=()=>{if(!R)return;R.innerHTML="";const t=d.getBoundingClientRect().width,r=D,l=60,c=t/r,s=l*c,S=(t-s*2)/(a-1),u=Math.max(10,S*.35);for(let n=0;n<a;n++){const E=document.createElement("span");E.className="coord-label",E.innerText=String.fromCharCode(65+(n>=8?n+1:n)),E.style.fontSize=`${u}px`,E.style.left=`${s+n*S}px`,E.style.top=`${s*.4}px`,R.appendChild(E)}for(let n=0;n<a;n++){const E=document.createElement("span");E.className="coord-label",E.innerText=(a-n).toString(),E.style.fontSize=`${u}px`,E.style.left=`${s*.4}px`,E.style.top=`${s+n*S}px`,R.appendChild(E)}},V=()=>{d.width=D*w,d.height=D*w,y=60*w,requestAnimationFrame(U)};new ResizeObserver(()=>{U()}).observe(d),V();const N=e=>{i=Array(e).fill(0).map(()=>Array(e).fill(null)),z=Array(e).fill(0).map(()=>Array(e).fill(null))},X=()=>{window.dispatchEvent(new CustomEvent("unlock-next-problem")),setTimeout(()=>{f.querySelectorAll(".next-btn, #nextBtn").forEach(e=>{e instanceof HTMLButtonElement&&(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer",e.classList.add("glow-animation"))})},100);try{window.handleMoveResult&&window.handleMoveResult(!0)}catch{}};function m(e,t){$&&($.innerText=e,$.style.color=t)}const H=()=>{if(!b)return;const{x:e,y:t,color:r}=b;!i[e][t]&&!L&&(i[e][t]={color:r});const l=i[e][t];i[e][t]=null,v(),setTimeout(()=>{i[e][t]=l,M&&(M.currentTime=0,M.play().catch(()=>{})),v()},600)},q=f.getAttribute("data-problem");if(q)try{const e=JSON.parse(q);if(a=e.size||9,N(a),e.labels&&(z=typeof e.labels=="string"?JSON.parse(e.labels):e.labels),h=e.turn||"black",b=e.lastMove||null,e.initialState){B=e.initialState;const t=JSON.parse(e.initialState);Array.isArray(t)&&Array.isArray(t[0])?i=t:Array.isArray(t)&&t.forEach(r=>{r&&(i[r.x][r.y]={color:r.color})})}if(e.solution)if(Array.isArray(e.solution)&&e.solution.length>0){let t=k;e.solution.forEach(r=>{const l={...r,children:[],status:null};t.children.push(l),t=l}),t.status="correct",O=!0}else e.solution.children&&e.solution.children.length>0?(k=e.solution,O=!0):O=!1;else O=!1;p=k,L||(A="SOLVE",b&&setTimeout(H,300))}catch(e){console.error(e)}else N(a),O=!1;!L&&!O&&setTimeout(()=>{m("Analiz Modu","#3498db"),X()},100);const _=e=>{a=e,N(a),k={children:[]},p=k,x=[],B="",h="black",b=null,f.querySelectorAll(".size-btn").forEach(t=>{t.getAttribute("data-size")==String(e)?t.classList.add("active"):t.classList.remove("active")}),v(),U(),m(`${a}x${a} Tahta`,"#fff")};L&&f.querySelectorAll(".size-btn").forEach(e=>e.addEventListener("click",t=>_(parseInt(t.target.getAttribute("data-size")||"9"))));const P=(e,t)=>e>=0&&e<a&&t>=0&&t<a,Y=(e,t,r,l=new Set)=>{const c=`${e},${t}`;if(l.has(c))return 0;l.add(c);let s=0;return[[e+1,t],[e-1,t],[e,t+1],[e,t-1]].forEach(([S,u])=>{P(S,u)&&(i[S][u]?i[S][u].color===r&&(s+=Y(S,u,r,l)):s++)}),s},G=(e,t,r)=>{const l=i[e][t];!l||l.color!==r||(i[e][t]=null,[[e+1,t],[e-1,t],[e,t+1],[e,t-1]].forEach(([c,s])=>{P(c,s)&&G(c,s,r)}))},J=(e,t,r)=>{if(i[e][t])return!1;const l=JSON.stringify(i);i[e][t]={color:r};let c=!1;const s=r==="black"?"white":"black";if([[e+1,t],[e-1,t],[e,t+1],[e,t-1]].forEach(([u,n])=>{P(u,n)&&i[u][n]&&i[u][n].color===s&&Y(u,n,s)===0&&(G(u,n,s),c=!0)}),!c&&Y(e,t,r)===0)return i=JSON.parse(l),m("İntihar Yasak!","#e74c3c"),!1;const S=JSON.stringify(i);return T.length>0&&T[T.length-1]===S?(i=JSON.parse(l),m("Ko!","#e74c3c"),!1):(T.push(l),T.length>2&&T.shift(),M&&(M.currentTime=0,M.play().catch(()=>{})),!0)},v=()=>{if(!d)return;o.clearRect(0,0,d.width,d.height),o.fillStyle="#f2b06d",o.fillRect(0,0,d.width,d.height);const e=(d.width-y*2)/(a-1);o.lineWidth=1.1*w,o.strokeStyle="#2b1d0e",o.beginPath();for(let r=0;r<a;r++){const l=Math.round(y+r*e)+.5;o.moveTo(l,y),o.lineTo(l,d.height-y),o.moveTo(y,l),o.lineTo(d.width-y,l)}o.stroke();const t=a===19?[3,9,15]:a===13?[3,6,9]:[2,4,6];a>=9&&(o.fillStyle="#000",t.forEach(r=>{t.forEach(l=>{o.beginPath(),o.arc(Math.round(y+r*e),Math.round(y+l*e),3*w,0,Math.PI*2),o.fill()})})),o.fillStyle="#000",o.font=`bold ${e*.5}px sans-serif`,o.textAlign="center",o.textBaseline="middle";for(let r=0;r<a;r++)for(let l=0;l<a;l++)z[r][l]&&o.fillText(z[r][l],y+r*e,y+l*e);if(i.forEach((r,l)=>r.forEach((c,s)=>{c&&K(l,s,c.color,e,1)})),b&&i[b.x][b.y]){const r=y+b.x*e,l=y+b.y*e,c=i[b.x][b.y].color==="black"?"rgba(255,255,255,0.9)":"rgba(0,0,0,0.9)";o.beginPath(),o.arc(r,l,e*.12,0,2*Math.PI),o.fillStyle=c,o.fill()}!C&&g.x>=0&&g.x<a&&g.y>=0&&g.y<a&&!i[g.x][g.y]&&K(g.x,g.y,h,e,.5)},K=(e,t,r,l,c)=>{const s=Math.round(y+e*l),S=Math.round(y+t*l),u=l*.48;if(o.save(),o.globalAlpha=c,c===1&&(o.shadowColor="rgba(0,0,0,0.3)",o.shadowBlur=4*w,o.shadowOffsetX=1.5*w,o.shadowOffsetY=1.5*w),o.beginPath(),o.arc(s,S,u,0,Math.PI*2),r==="black"){const n=o.createRadialGradient(s-u*.3,S-u*.3,u*.1,s,S,u);n.addColorStop(0,"#666"),n.addColorStop(.3,"#222"),n.addColorStop(1,"#000"),o.fillStyle=n}else{const n=o.createRadialGradient(s-u*.3,S-u*.4,u*.05,s,S,u);n.addColorStop(0,"#fff"),n.addColorStop(.5,"#f0f0f0"),n.addColorStop(1,"#ccc"),o.fillStyle=n}o.fill(),r==="white"&&c===1&&(o.shadowColor="transparent",o.lineWidth=.5*w,o.strokeStyle="rgba(0,0,0,0.2)",o.stroke()),o.restore()};d.addEventListener("mousemove",e=>{if(A==="SOLVE"&&C){d.style.cursor="default";return}const t=d.getBoundingClientRect(),r=(e.clientX-t.left)*(d.width/t.width)-y,l=(e.clientY-t.top)*(d.height/t.height)-y,c=(d.width-y*2)/(a-1),s=Math.round(r/c),S=Math.round(l/c);P(s,S)?(g.x!==s||g.y!==S)&&(g={x:s,y:S},d.style.cursor="pointer",v()):g.x!==-1&&(g={x:-1,y:-1},d.style.cursor="default",v())}),d.addEventListener("mouseleave",()=>{g={x:-1,y:-1},v()}),d.addEventListener("click",()=>{if(A==="SOLVE"&&C){m("Tekrar deneyin","#e74c3c");return}if(g.x===-1)return;const{x:e,y:t}=g;if(!i[e][t]){if(A==="SETUP")i[e][t]=!i[e][t]||i[e][t].color!==h?{color:h}:null,v();else if(A==="RECORD"){if(i[e][t])return;const r=JSON.stringify(i),l=h;if(!J(e,t,h))return;const c=p.children.find(s=>s.x===e&&s.y===t);if(c)x.push({node:p,stonesSnapshot:r,turn:l}),p=c,m("Mevcut Dal","#3498db");else{const s={x:e,y:t,color:h,children:[],status:null};p.children.push(s),x.push({node:p,stonesSnapshot:r,turn:l}),p=s,m("Yeni Varyasyon","#f1c40f")}h=h==="black"?"white":"black",v()}else if(A==="SOLVE"){if(!O){J(e,t,h)&&(h=h==="black"?"white":"black",v());return}const r=p.children.find(l=>l.x===e&&l.y===t);r?(J(e,t,r.color),p=r,h=h==="black"?"white":"black",v(),W(p),p.children?.length&&!p.status&&setTimeout(()=>{const l=p.children[Math.floor(Math.random()*p.children.length)];J(l.x,l.y,l.color),p=l,h=h==="black"?"white":"black",v(),W(p)},500)):(m("Yanlış Hamle","#e74c3c"),C=!0,f.classList.add("locked"),window.handleMoveResult&&window.handleMoveResult(!1))}}});const W=e=>{e.status==="correct"?F():e.status==="wrong"?ee():e.children?.length||F()},F=()=>{m("Tebrikler!","#2ecc71"),C=!0,f.classList.add("locked"),X()},ee=()=>{m("Yanlış Yol","#e74c3c"),C=!0,f.classList.add("locked"),window.handleMoveResult&&window.handleMoveResult(!1)},j=e=>{if(e==="SETUP"){if(B){const t=JSON.parse(B);Array.isArray(t)&&Array.isArray(t[0])&&(i=t),k={children:[]},p=k,x=[]}m("Taşları dizin.","#fff")}e==="RECORD"&&A==="SETUP"&&(B=JSON.stringify(i),I=h,k={children:[]},p=k,x=[],m("Kayıt Başladı.","#f1c40f")),A=e,f.querySelectorAll(".control-btn").forEach(t=>t.classList.remove("active")),e==="SETUP"&&f.querySelector(".setupBtn")?.classList.add("active"),e==="RECORD"&&f.querySelector(".recordBtn")?.classList.add("active")};L&&(f.querySelector(".resetBtn")?.addEventListener("click",()=>{i=Array(a).fill(0).map(()=>Array(a).fill(null)),v()}),f.querySelector(".setupBtn")?.addEventListener("click",()=>j("SETUP")),f.querySelector(".recordBtn")?.addEventListener("click",()=>j("RECORD")),f.querySelector(".exportBtn")?.addEventListener("click",()=>{const e=prompt("Başlık")||"Soru",t={id:`p-${Date.now()}`,size:a,turn:I,title:e,initialState:B||JSON.stringify(i),solution:k};console.log(JSON.stringify(t)),alert("Konsola yazıldı")}),f.querySelector(".colorToggleBtn")?.addEventListener("click",()=>{h=h==="black"?"white":"black",document.getElementById("teacherColorIndicator")?.classList.toggle("black"),document.getElementById("teacherColorIndicator")?.classList.toggle("white")})),f.querySelector(".resetBtn")?.addEventListener("click",()=>{if(m("","#fff"),C=!1,f.classList.remove("locked"),g={x:-1,y:-1},T=[],!L&&q){const e=JSON.parse(q);if(h=e.turn||"black",e.initialState){const t=JSON.parse(e.initialState);Array.isArray(t[0])&&(i=t)}else N(a);p=k,x=[],b&&setTimeout(H,300)}v()}),f.setAttribute("data-initialized","true"),V()})};document.addEventListener("astro:page-load",Q);document.addEventListener("DOMContentLoaded",Q);
