const H=()=>{document.querySelectorAll(".go-app").forEach(c=>{if(c.getAttribute("data-initialized"))return;const S=c.querySelector(".goBoard"),M=c.querySelector(".status"),T=c.getAttribute("data-teacher")==="true",l=S.getContext("2d",{alpha:!1});if(!l)return;let s=9;const A=2,Y=500;let v=30*A,m=T?"SETUP":"SOLVE",w=[],C=!1,R=1,n=[],d="black",L="",U="black",b={children:[]},a=b,B=[],N=!1,g={x:-1,y:-1},O=!1;(()=>{S.width=Y*A,S.height=Y*A})();const p=t=>{n=Array(t).fill(0).map(()=>Array(t).fill(null)),w=Array(t).fill(0).map(()=>Array(t).fill(null))},x=()=>{typeof window.handleMoveResult=="function"&&window.handleMoveResult(!0),typeof window.unlockNextButton=="function"&&window.unlockNextButton(),setTimeout(()=>{typeof window.unlockNextButton=="function"&&window.unlockNextButton()},500)},z=c.getAttribute("data-problem");if(z)try{const t=JSON.parse(z);if(s=t.size||9,p(s),t.labels&&(w=typeof t.labels=="string"?JSON.parse(t.labels):t.labels),t.turn?d=t.turn:d="black",t.initialState){L=t.initialState;const e=JSON.parse(t.initialState);Array.isArray(e)&&(Array.isArray(e[0])?n=e:e.forEach(r=>{r&&r.x!==void 0&&(n[r.x][r.y]={color:r.color})}))}if(t.solution)if(Array.isArray(t.solution)){let e=b;t.solution.forEach(r=>{const i={...r,children:[],status:null};e.children.push(i),e=i}),e.status="correct"}else b=t.solution;a=b,T||(m="SOLVE")}catch(t){console.error(t)}else p(s);b&&(Array.isArray(b)&&b.length>0||b.children&&b.children.length>0)&&(N=!0),!T&&!N&&(y("Serbest Analiz Modu (Cevap gerekmez)","#3498db"),x());const F=t=>{s=t,p(s),b={children:[]},a=b,B=[],L="",d="black",document.querySelectorAll(".size-btn").forEach(e=>{e.getAttribute("data-size")==t?e.classList.add("active"):e.classList.remove("active")}),E(),y(`${s}x${s} Tahta Hazır`,"#fff")};T&&c.querySelectorAll(".size-btn").forEach(t=>{t.addEventListener("click",e=>{const r=parseInt(e.target.getAttribute("data-size")||"9");F(r)})});const P=(t,e)=>t>=0&&t<s&&e>=0&&e<s,J=(t,e,r,i=new Set)=>{const o=`${t},${e}`;if(i.has(o))return 0;i.add(o);let h=0;return[[t+1,e],[t-1,e],[t,e+1],[t,e-1]].forEach(([u,k])=>{if(!P(u,k))return;const W=n[u][k];W?W.color===r&&(h+=J(u,k,r,i)):h++}),h},$=(t,e,r)=>{const i=n[t][e];if(!i||i.color!==r)return;n[t][e]=null,[[t+1,e],[t-1,e],[t,e+1],[t,e-1]].forEach(([h,f])=>{P(h,f)&&$(h,f,r)})},D=(t,e,r)=>{if(n[t][e])return!1;n[t][e]={color:r};let i=!1;const o=r==="black"?"white":"black";return[[t+1,e],[t-1,e],[t,e+1],[t,e-1]].forEach(([f,u])=>{P(f,u)&&n[f][u]&&n[f][u].color===o&&J(f,u,o)===0&&($(f,u,o),i=!0)}),!i&&J(t,e,r)===0?(n[t][e]=null,y("İntihar hamlesi yasak!","#e74c3c"),!1):!0},E=()=>{l.fillStyle="#eebb66",l.fillRect(0,0,S.width,S.height);const t=(S.width-v*2)/(s-1);l.lineWidth=1.5*A,l.strokeStyle="#000",l.beginPath();for(let r=0;r<s;r++){const i=Math.round(v+r*t);l.moveTo(i,v),l.lineTo(i,S.height-v),l.moveTo(v,i),l.lineTo(S.width-v,i),l.fillStyle="#000",l.font=`bold ${12*A}px sans-serif`,l.textAlign="center",l.textBaseline="middle";const o=String.fromCharCode(65+(r>=8?r+1:r));l.fillText(o,i,S.height-10*A),l.fillText((s-r).toString(),15*A,i)}l.stroke();const e=s===19?[3,9,15]:s===13?[3,6,9]:[2,4,6];s>=9&&(l.fillStyle="#000",e.forEach(r=>{e.forEach(i=>{l.beginPath(),l.arc(v+r*t,v+i*t,3*A,0,Math.PI*2),l.fill()})})),l.fillStyle="#000",l.font=`bold ${t*.5}px sans-serif`,l.textAlign="center",l.textBaseline="middle";for(let r=0;r<s;r++)for(let i=0;i<s;i++)if(w[r][i]){const o=v+r*t,h=v+i*t;l.fillText(w[r][i],o,h)}n.forEach((r,i)=>r.forEach((o,h)=>{o&&I(i,h,o.color,t,1)})),!O&&g.x>=0&&g.x<s&&g.y>=0&&g.y<s&&(n[g.x][g.y]||I(g.x,g.y,d,t,.5))},I=(t,e,r,i,o)=>{const h=v+t*i,f=v+e*i,u=i*.45;if(l.save(),l.globalAlpha=o,o===1&&(l.shadowColor="rgba(0,0,0,0.3)",l.shadowBlur=3*A,l.shadowOffsetX=1*A,l.shadowOffsetY=1*A),l.beginPath(),l.arc(h,f,u,0,Math.PI*2),r==="black"){const k=l.createRadialGradient(h-u*.3,f-u*.3,u*.1,h,f,u);k.addColorStop(0,"#555"),k.addColorStop(1,"#000"),l.fillStyle=k}else{const k=l.createRadialGradient(h-u*.3,f-u*.3,u*.1,h,f,u);k.addColorStop(0,"#fff"),k.addColorStop(1,"#ddd"),l.fillStyle=k}l.fill(),r==="white"&&o===1&&(l.lineWidth=1,l.strokeStyle="#ccc",l.stroke()),l.restore()};S.addEventListener("mousemove",t=>{if(m==="SOLVE"&&O){S.style.cursor="default";return}const e=S.getBoundingClientRect(),r=S.width/e.width,i=S.height/e.height,o=(t.clientX-e.left)*r-v,h=(t.clientY-e.top)*i-v,f=(S.width-v*2)/(s-1),u=Math.round(o/f),k=Math.round(h/f);u>=0&&u<s&&k>=0&&k<s?(g.x!==u||g.y!==k)&&(g={x:u,y:k},S.style.cursor="pointer",E()):g.x!==-1&&(g={x:-1,y:-1},S.style.cursor="default",E())}),S.addEventListener("mouseleave",()=>{g={x:-1,y:-1},E()}),S.addEventListener("click",t=>{if(m==="SOLVE"&&O){y("Tekrar denemek için 'Yenile' butonuna basın.","#e74c3c");return}if(g.x===-1)return;const e=g.x,r=g.y;if(C){w[e][r]?w[e][r]=null:w[e][r]=R++,E();return}if(m==="SETUP")n[e][r]=n[e][r]&&n[e][r].color===d?null:{color:d},E();else if(m==="RECORD"){if(n[e][r])return;const i=JSON.stringify(n),o=d;if(!D(e,r,d))return;let h=a.children.find(f=>f.x===e&&f.y===r);if(h)B.push({node:a,stonesSnapshot:i,turn:o}),a=h,y("Mevcut dalda ilerlendi.","#3498db");else{const f={x:e,y:r,color:d,children:[],status:null};a.children.push(f),B.push({node:a,stonesSnapshot:i,turn:o}),a=f,y("Yeni varyasyon kaydediliyor...","#f1c40f")}d=d==="black"?"white":"black",E()}else if(m==="SOLVE"){if(!N){if(n[e][r])return;n[e][r]={color:d},d=d==="black"?"white":"black",E(),y("Serbest Analiz Modu","#3498db");return}const i=a.children.find(o=>o.x===e&&o.y===r);i?(D(e,r,i.color),a=i,d=d==="black"?"white":"black",E(),X(a),a.children&&a.children.length>0&&!a.status&&setTimeout(()=>{const o=a.children[0];D(o.x,o.y,o.color),a=o,d=d==="black"?"white":"black",E(),X(a)},500)):(y("Tanımsız hamle. (Yanlış olabilir)","#e74c3c"),O=!0,c.classList.add("locked"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!1))}});function X(t){if(t.status==="correct"){V();return}if(t.status==="wrong"){K();return}(!t.children||t.children.length===0)&&V()}function V(){y("Tebrikler! Doğru Çözüm.","#2ecc71"),O=!0,c.classList.add("locked"),x()}function K(){y("Yanlış yol! (Yenile butonuna basınız)","#e74c3c"),O=!0,c.classList.add("locked"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!1)}function y(t,e){M&&(M.innerText=t,M.style.color=e)}if(T){c.querySelector("#undoBtn")?.addEventListener("click",()=>{if(B.length>0){const e=B.pop();a=e.node,n=JSON.parse(e.stonesSnapshot),d=e.turn,y("Geri alındı.","#fff"),E()}}),c.querySelector("#markCorrectBtn")?.addEventListener("click",()=>{a!==b&&(a.status="correct",y("Bu dal 'DOĞRU' işaretlendi.","#2ecc71"))}),c.querySelector("#markWrongBtn")?.addEventListener("click",()=>{a!==b&&(a.status="wrong",y("Bu dal 'YANLIŞ' işaretlendi.","#e74c3c"))}),c.querySelector(".setupBtn")?.addEventListener("click",()=>G("SETUP")),c.querySelector(".recordBtn")?.addEventListener("click",()=>G("RECORD")),c.querySelector(".exportBtn")?.addEventListener("click",()=>{const e={id:`prob-${Date.now()}`,size:s,labels:JSON.stringify(w),turn:U,initialState:L||JSON.stringify(n),solution:b};console.log(JSON.stringify(e,null,2)),alert("Ağaç yapısı (Tree) Console'a yazdırıldı!")});const t=c.querySelector(".colorToggleBtn");t&&t.addEventListener("click",()=>{d=d==="black"?"white":"black";const e=document.getElementById("teacherColorIndicator");e&&(e.classList.toggle("black"),e.classList.toggle("white"))})}const G=t=>{if(t==="SETUP"){if(L){const e=JSON.parse(L);Array.isArray(e)&&Array.isArray(e[0])&&(n=e),b={children:[]},a=b,B=[]}y("Taşları dizin.","#fff")}t==="RECORD"&&m==="SETUP"&&(L=JSON.stringify(n),U=d,b={children:[]},a=b,B=[],y("Kayıt Başladı.","#f1c40f")),m=t,c.querySelectorAll(".control-btn").forEach(e=>e.classList.remove("active")),t==="SETUP"&&c.querySelector(".setupBtn")?.classList.add("active"),t==="RECORD"&&c.querySelector(".recordBtn")?.classList.add("active")};c.querySelector(".resetBtn")?.addEventListener("click",()=>{if(y("","#fff"),O=!1,c.classList.remove("locked"),w=Array(s).fill(0).map(()=>Array(s).fill(null)),R=1,C=!1,c.querySelector(".labelBtn")?.classList.remove("active"),T&&m==="SETUP")p(s);else{const t=z?JSON.parse(z):{};if(t.turn?d=t.turn:d="black",L){const e=JSON.parse(L);Array.isArray(e)&&Array.isArray(e[0])?n=e:(p(s),Array.isArray(e)&&e.forEach(r=>{r&&(n[r.x][r.y]={color:r.color})}))}else p(s);t.labels&&(w=typeof t.labels=="string"?JSON.parse(t.labels):t.labels),a=b,B=[],!T&&!N&&(y("Serbest Analiz Modu","#3498db"),x())}E()});const q=c.querySelector(".labelBtn");q&&q.addEventListener("click",()=>{C=!C,C?(q.classList.add("active"),y(`Etiket Modu: ${R}'den başlıyor`,"#000")):(q.classList.remove("active"),y("Mod kapatıldı.","#fff"))}),window.resetAllBoards||(window.resetAllBoards=()=>{document.querySelectorAll(".resetBtn").forEach(e=>{e instanceof HTMLElement&&e.click()})}),c.setAttribute("data-initialized","true"),E()})};document.addEventListener("astro:page-load",H);document.addEventListener("DOMContentLoaded",H);
