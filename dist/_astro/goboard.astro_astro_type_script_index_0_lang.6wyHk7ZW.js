const W=()=>{document.querySelectorAll(".go-app").forEach(d=>{if(d.getAttribute("data-initialized"))return;const S=d.querySelector(".goBoard"),M=d.querySelector(".status"),p=d.getAttribute("data-teacher")==="true",i=S.getContext("2d",{alpha:!1});if(!i)return;let n=9;const m=2,J=500;let v=30*m,w=p?"SETUP":"SOLVE",A=[],C=!1,R=1,s=[],f="black",L="",U="black",b={children:[]},c=b,B=[],N=!1,g={x:-1,y:-1},T=!1;(()=>{S.width=J*m,S.height=J*m})();const O=t=>{s=Array(t).fill(0).map(()=>Array(t).fill(null)),A=Array(t).fill(0).map(()=>Array(t).fill(null))},x=()=>{typeof window.handleMoveResult=="function"&&window.handleMoveResult(!0),typeof window.unlockNextButton=="function"&&window.unlockNextButton(),setTimeout(()=>{typeof window.unlockNextButton=="function"&&window.unlockNextButton()},500)},z=d.getAttribute("data-problem");if(z)try{const t=JSON.parse(z);if(n=t.size||9,O(n),t.labels&&(A=typeof t.labels=="string"?JSON.parse(t.labels):t.labels),t.turn?f=t.turn:f="black",t.initialState){L=t.initialState;const e=JSON.parse(t.initialState);Array.isArray(e)&&(Array.isArray(e[0])?s=e:e.forEach(r=>{r&&r.x!==void 0&&(s[r.x][r.y]={color:r.color})}))}if(t.solution)if(Array.isArray(t.solution)){let e=b;t.solution.forEach(r=>{const l={...r,children:[],status:null};e.children.push(l),e=l}),e.status="correct"}else b=t.solution;c=b,p||(w="SOLVE")}catch(t){console.error(t)}else O(n);b&&(Array.isArray(b)&&b.length>0||b.children&&b.children.length>0)&&(N=!0),!p&&!N&&(y("Serbest Analiz Modu (Cevap gerekmez)","#3498db"),x());const F=t=>{n=t,O(n),b={children:[]},c=b,B=[],L="",f="black",document.querySelectorAll(".size-btn").forEach(e=>{e.getAttribute("data-size")==t?e.classList.add("active"):e.classList.remove("active")}),E(),y(`${n}x${n} Tahta Hazır`,"#fff")};p&&d.querySelectorAll(".size-btn").forEach(t=>{t.addEventListener("click",e=>{const r=parseInt(e.target.getAttribute("data-size")||"9");F(r)})});const P=(t,e)=>t>=0&&t<n&&e>=0&&e<n,Y=(t,e,r,l=new Set)=>{const o=`${t},${e}`;if(l.has(o))return 0;l.add(o);let h=0;return[[t+1,e],[t-1,e],[t,e+1],[t,e-1]].forEach(([u,k])=>{if(!P(u,k))return;const j=s[u][k];j?j.color===r&&(h+=Y(u,k,r,l)):h++}),h},$=(t,e,r)=>{const l=s[t][e];if(!l||l.color!==r)return;s[t][e]=null,[[t+1,e],[t-1,e],[t,e+1],[t,e-1]].forEach(([h,a])=>{P(h,a)&&$(h,a,r)})},D=(t,e,r)=>{if(s[t][e])return!1;s[t][e]={color:r};let l=!1;const o=r==="black"?"white":"black";return[[t+1,e],[t-1,e],[t,e+1],[t,e-1]].forEach(([a,u])=>{P(a,u)&&s[a][u]&&s[a][u].color===o&&Y(a,u,o)===0&&($(a,u,o),l=!0)}),!l&&Y(t,e,r)===0?(s[t][e]=null,y("İntihar hamlesi yasak!","#e74c3c"),!1):!0},E=()=>{i.fillStyle="#eebb66",i.fillRect(0,0,S.width,S.height);const t=(S.width-v*2)/(n-1);i.lineWidth=1.5*m,i.strokeStyle="#000",i.beginPath();for(let r=0;r<n;r++){const l=Math.round(v+r*t);i.moveTo(l,v),i.lineTo(l,S.height-v),i.moveTo(v,l),i.lineTo(S.width-v,l),i.fillStyle="#000",i.font=`bold ${12*m}px sans-serif`,i.textAlign="center",i.textBaseline="middle";const o=String.fromCharCode(65+(r>=8?r+1:r));i.fillText(o,l,S.height-10*m),i.fillText((n-r).toString(),15*m,l)}i.stroke();const e=n===19?[3,9,15]:n===13?[3,6,9]:[2,4,6];n>=9&&(i.fillStyle="#000",e.forEach(r=>{e.forEach(l=>{i.beginPath(),i.arc(v+r*t,v+l*t,3*m,0,Math.PI*2),i.fill()})})),i.fillStyle="#000",i.font=`bold ${t*.5}px sans-serif`,i.textAlign="center",i.textBaseline="middle";for(let r=0;r<n;r++)for(let l=0;l<n;l++)if(A[r][l]){const o=v+r*t,h=v+l*t;i.fillText(A[r][l],o,h)}s.forEach((r,l)=>r.forEach((o,h)=>{o&&G(l,h,o.color,t,1)})),!T&&g.x>=0&&g.x<n&&g.y>=0&&g.y<n&&(s[g.x][g.y]||G(g.x,g.y,f,t,.5))},G=(t,e,r,l,o)=>{const h=v+t*l,a=v+e*l,u=l*.45;if(i.save(),i.globalAlpha=o,o===1&&(i.shadowColor="rgba(0,0,0,0.3)",i.shadowBlur=3*m,i.shadowOffsetX=1*m,i.shadowOffsetY=1*m),i.beginPath(),i.arc(h,a,u,0,Math.PI*2),r==="black"){const k=i.createRadialGradient(h-u*.3,a-u*.3,u*.1,h,a,u);k.addColorStop(0,"#555"),k.addColorStop(1,"#000"),i.fillStyle=k}else{const k=i.createRadialGradient(h-u*.3,a-u*.3,u*.1,h,a,u);k.addColorStop(0,"#fff"),k.addColorStop(1,"#ddd"),i.fillStyle=k}i.fill(),r==="white"&&o===1&&(i.lineWidth=1,i.strokeStyle="#ccc",i.stroke()),i.restore()};S.addEventListener("mousemove",t=>{if(w==="SOLVE"&&T){S.style.cursor="default";return}const e=S.getBoundingClientRect(),r=S.width/e.width,l=S.height/e.height,o=(t.clientX-e.left)*r-v,h=(t.clientY-e.top)*l-v,a=(S.width-v*2)/(n-1),u=Math.round(o/a),k=Math.round(h/a);u>=0&&u<n&&k>=0&&k<n?(g.x!==u||g.y!==k)&&(g={x:u,y:k},S.style.cursor="pointer",E()):g.x!==-1&&(g={x:-1,y:-1},S.style.cursor="default",E())}),S.addEventListener("mouseleave",()=>{g={x:-1,y:-1},E()}),S.addEventListener("click",t=>{if(w==="SOLVE"&&T){y("Tekrar denemek için 'Yenile' butonuna basın.","#e74c3c");return}if(g.x===-1)return;const e=g.x,r=g.y;if(C){A[e][r]?A[e][r]=null:A[e][r]=R++,E();return}if(w==="SETUP")s[e][r]=s[e][r]&&s[e][r].color===f?null:{color:f},E();else if(w==="RECORD"){if(s[e][r])return;const l=JSON.stringify(s),o=f;if(!D(e,r,f))return;let h=c.children.find(a=>a.x===e&&a.y===r);if(h)B.push({node:c,stonesSnapshot:l,turn:o}),c=h,y("Mevcut dalda ilerlendi.","#3498db");else{const a={x:e,y:r,color:f,children:[],status:null};c.children.push(a),B.push({node:c,stonesSnapshot:l,turn:o}),c=a,y("Yeni varyasyon kaydediliyor...","#f1c40f")}f=f==="black"?"white":"black",E()}else if(w==="SOLVE"){if(!N){if(s[e][r])return;s[e][r]={color:f},f=f==="black"?"white":"black",E(),y("Serbest Analiz Modu","#3498db");return}const l=c.children.find(o=>o.x===e&&o.y===r);l?(D(e,r,l.color),c=l,f=f==="black"?"white":"black",E(),I(c),c.children&&c.children.length>0&&!c.status&&setTimeout(()=>{const o=c.children[0];D(o.x,o.y,o.color),c=o,f=f==="black"?"white":"black",E(),I(c)},500)):(y("Tanımsız hamle. (Yanlış olabilir)","#e74c3c"),T=!0,d.classList.add("locked"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!1))}});function I(t){if(t.status==="correct"){X();return}if(t.status==="wrong"){H();return}(!t.children||t.children.length===0)&&X()}function X(){y("Tebrikler! Doğru Çözüm.","#2ecc71"),T=!0,d.classList.add("locked"),x()}function H(){y("Yanlış yol! (Yenile butonuna basınız)","#e74c3c"),T=!0,d.classList.add("locked"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!1)}function y(t,e){M&&(M.innerText=t,M.style.color=e)}if(p){d.querySelector("#undoBtn")?.addEventListener("click",()=>{if(B.length>0){const e=B.pop();c=e.node,s=JSON.parse(e.stonesSnapshot),f=e.turn,y("Geri alındı.","#fff"),E()}}),d.querySelector("#markCorrectBtn")?.addEventListener("click",()=>{c!==b&&(c.status="correct",y("Bu dal 'DOĞRU' işaretlendi.","#2ecc71"))}),d.querySelector("#markWrongBtn")?.addEventListener("click",()=>{c!==b&&(c.status="wrong",y("Bu dal 'YANLIŞ' işaretlendi.","#e74c3c"))}),d.querySelector(".setupBtn")?.addEventListener("click",()=>V("SETUP")),d.querySelector(".recordBtn")?.addEventListener("click",()=>V("RECORD")),d.querySelector(".exportBtn")?.addEventListener("click",()=>{const e=prompt("Soru Başlığı (Title):","Yeni Go Sorusu")||"İsimsiz Soru",r=prompt("Kategori (örn: Yaşam/Ölüm):","Genel")||"Genel",l=prompt("Açıklama (Description):","Siyah oynar ve kazanır.")||"",o={id:`prob-${Date.now()}`,size:n,labels:JSON.stringify(A),turn:U,title:e,category:r,description:l,initialState:L||JSON.stringify(s),solution:b},a=JSON.stringify(o,null,2).replace(/"(\w+)":/g,"$1:");console.log(a),alert("TypeScript formatında veri hazır! Console'u (F12) açıp kopyalayabilirsiniz.")});const t=d.querySelector(".colorToggleBtn");t&&t.addEventListener("click",()=>{f=f==="black"?"white":"black";const e=document.getElementById("teacherColorIndicator");e&&(e.classList.toggle("black"),e.classList.toggle("white"))})}const V=t=>{if(t==="SETUP"){if(L){const e=JSON.parse(L);Array.isArray(e)&&Array.isArray(e[0])&&(s=e),b={children:[]},c=b,B=[]}y("Taşları dizin.","#fff")}t==="RECORD"&&w==="SETUP"&&(L=JSON.stringify(s),U=f,b={children:[]},c=b,B=[],y("Kayıt Başladı.","#f1c40f")),w=t,d.querySelectorAll(".control-btn").forEach(e=>e.classList.remove("active")),t==="SETUP"&&d.querySelector(".setupBtn")?.classList.add("active"),t==="RECORD"&&d.querySelector(".recordBtn")?.classList.add("active")};d.querySelector(".resetBtn")?.addEventListener("click",()=>{if(y("","#fff"),T=!1,d.classList.remove("locked"),A=Array(n).fill(0).map(()=>Array(n).fill(null)),R=1,C=!1,d.querySelector(".labelBtn")?.classList.remove("active"),p&&w==="SETUP")O(n);else{const t=z?JSON.parse(z):{};if(t.turn?f=t.turn:f="black",L){const e=JSON.parse(L);Array.isArray(e)&&Array.isArray(e[0])?s=e:(O(n),Array.isArray(e)&&e.forEach(r=>{r&&(s[r.x][r.y]={color:r.color})}))}else O(n);t.labels&&(A=typeof t.labels=="string"?JSON.parse(t.labels):t.labels),c=b,B=[],!p&&!N&&(y("Serbest Analiz Modu","#3498db"),x())}E()});const q=d.querySelector(".labelBtn");q&&q.addEventListener("click",()=>{C=!C,C?(q.classList.add("active"),y(`Etiket Modu: ${R}'den başlıyor`,"#000")):(q.classList.remove("active"),y("Mod kapatıldı.","#fff"))}),window.resetAllBoards||(window.resetAllBoards=()=>{document.querySelectorAll(".resetBtn").forEach(e=>{e instanceof HTMLElement&&e.click()})}),d.setAttribute("data-initialized","true"),E()})};document.addEventListener("astro:page-load",W);document.addEventListener("DOMContentLoaded",W);
