const K=()=>{document.querySelectorAll(".go-app").forEach(d=>{if(d.getAttribute("data-initialized"))return;const b=d.querySelector(".goBoard"),J=d.querySelector(".status"),T=d.getAttribute("data-teacher")==="true",o=b.getContext("2d",{alpha:!1});if(!o)return;let s=9;const E=2,I=500;let v=30*E,A=T?"SETUP":"SOLVE",C=[],p=[],q=!1,P=1,n=[],f="black",w="",$="black",k={children:[]},c=k,B=[],L=!1,g={x:-1,y:-1},z=!1;(()=>{b.width=I*E,b.height=I*E})();const N=e=>{n=Array(e).fill(0).map(()=>Array(e).fill(null)),p=Array(e).fill(0).map(()=>Array(e).fill(null))},Y=()=>{window.dispatchEvent(new CustomEvent("unlock-next-problem"));let e=0;const t=setInterval(()=>{e++;const l=document.querySelectorAll('#nextBtn, .next-problem-btn, [data-action="next"]');let r=!1;l.forEach(i=>{i instanceof HTMLElement&&(i.removeAttribute("disabled"),i.style.opacity="1",i.style.pointerEvents="auto",i.style.cursor="pointer",i.classList.remove("disabled","opacity-50","pointer-events-none","cursor-not-allowed"),i.style.display="",r=!0)}),(r||e>10)&&clearInterval(t)},100);try{typeof window.handleMoveResult=="function"&&window.handleMoveResult(!0)}catch{console.log("Eski fonksiyon bulunamadı")}};function S(e,t){J&&(J.innerText=e,J.style.color=t)}const M=d.getAttribute("data-problem");if(M)try{const e=JSON.parse(M);if(s=e.size||9,N(s),e.labels&&(p=typeof e.labels=="string"?JSON.parse(e.labels):e.labels),e.turn?f=e.turn:f="black",e.initialState){w=e.initialState;const t=JSON.parse(e.initialState);Array.isArray(t)&&(Array.isArray(t[0])?n=t:t.forEach(l=>{l&&l.x!==void 0&&(n[l.x][l.y]={color:l.color})}))}if(e.solution)if(Array.isArray(e.solution))if(e.solution.length>0){let t=k;e.solution.forEach(l=>{const r={...l,children:[],status:null};t.children.push(r),t=r}),t.status="correct",L=!0}else L=!1;else e.solution.children&&e.solution.children.length>0?(k=e.solution,L=!0):L=!1;else L=!1;c=k,T||(A="SOLVE")}catch(e){console.error(e)}else N(s),L=!1;!T&&!L&&setTimeout(()=>{S("Analiz Modu (Cevap gerekmez)","#3498db"),Y()},100);const W=e=>{s=e,N(s),k={children:[]},c=k,B=[],w="",f="black",document.querySelectorAll(".size-btn").forEach(t=>{t.getAttribute("data-size")==e?t.classList.add("active"):t.classList.remove("active")}),m(),S(`${s}x${s} Tahta Hazır`,"#fff")};T&&d.querySelectorAll(".size-btn").forEach(e=>{e.addEventListener("click",t=>{const l=parseInt(t.target.getAttribute("data-size")||"9");W(l)})});const D=(e,t)=>e>=0&&e<s&&t>=0&&t<s,U=(e,t,l,r=new Set)=>{const i=`${e},${t}`;if(r.has(i))return 0;r.add(i);let a=0;return[[e+1,t],[e-1,t],[e,t+1],[e,t-1]].forEach(([y,u])=>{if(!D(y,u))return;const O=n[y][u];O?O.color===l&&(a+=U(y,u,l,r)):a++}),a},G=(e,t,l)=>{const r=n[e][t];if(!r||r.color!==l)return;n[e][t]=null,[[e+1,t],[e-1,t],[e,t+1],[e,t-1]].forEach(([a,h])=>{D(a,h)&&G(a,h,l)})},x=(e,t,l)=>{if(n[e][t])return!1;const r=JSON.stringify(n);n[e][t]={color:l};let i=!1;const a=l==="black"?"white":"black";if([[e+1,t],[e-1,t],[e,t+1],[e,t-1]].forEach(([u,O])=>{D(u,O)&&n[u][O]&&n[u][O].color===a&&U(u,O,a)===0&&(G(u,O,a),i=!0)}),!i&&U(e,t,l)===0)return n=JSON.parse(r),S("İntihar hamlesi yasak!","#e74c3c"),!1;const y=JSON.stringify(n);return C.length>0&&C[C.length-1]===y?(n=JSON.parse(r),S("Ko Kuralı: Aynı pozisyona dönülemez!","#e74c3c"),!1):(C.push(r),C.length>2&&C.shift(),!0)},m=()=>{o.fillStyle="#eebb66",o.fillRect(0,0,b.width,b.height);const e=(b.width-v*2)/(s-1);o.lineWidth=1.5*E,o.strokeStyle="#000",o.beginPath();for(let l=0;l<s;l++){const r=Math.round(v+l*e);o.moveTo(r,v),o.lineTo(r,b.height-v),o.moveTo(v,r),o.lineTo(b.width-v,r),o.fillStyle="#000",o.font=`bold ${12*E}px sans-serif`,o.textAlign="center",o.textBaseline="middle";const i=String.fromCharCode(65+(l>=8?l+1:l));o.fillText(i,r,b.height-10*E),o.fillText((s-l).toString(),15*E,r)}o.stroke();const t=s===19?[3,9,15]:s===13?[3,6,9]:[2,4,6];s>=9&&(o.fillStyle="#000",t.forEach(l=>{t.forEach(r=>{o.beginPath(),o.arc(v+l*e,v+r*e,3*E,0,Math.PI*2),o.fill()})})),o.fillStyle="#000",o.font=`bold ${e*.5}px sans-serif`,o.textAlign="center",o.textBaseline="middle";for(let l=0;l<s;l++)for(let r=0;r<s;r++)if(p[l][r]){const i=v+l*e,a=v+r*e;o.fillText(p[l][r],i,a)}n.forEach((l,r)=>l.forEach((i,a)=>{i&&X(r,a,i.color,e,1)})),!z&&g.x>=0&&g.x<s&&g.y>=0&&g.y<s&&(n[g.x][g.y]||X(g.x,g.y,f,e,.5))},X=(e,t,l,r,i)=>{const a=v+e*r,h=v+t*r,y=r*.45;if(o.save(),o.globalAlpha=i,i===1&&(o.shadowColor="rgba(0,0,0,0.3)",o.shadowBlur=3*E,o.shadowOffsetX=1*E,o.shadowOffsetY=1*E),o.beginPath(),o.arc(a,h,y,0,Math.PI*2),l==="black"){const u=o.createRadialGradient(a-y*.3,h-y*.3,y*.1,a,h,y);u.addColorStop(0,"#555"),u.addColorStop(1,"#000"),o.fillStyle=u}else{const u=o.createRadialGradient(a-y*.3,h-y*.3,y*.1,a,h,y);u.addColorStop(0,"#fff"),u.addColorStop(1,"#ddd"),o.fillStyle=u}o.fill(),l==="white"&&i===1&&(o.lineWidth=1,o.strokeStyle="#ccc",o.stroke()),o.restore()};b.addEventListener("mousemove",e=>{if(A==="SOLVE"&&z){b.style.cursor="default";return}const t=b.getBoundingClientRect(),l=b.width/t.width,r=b.height/t.height,i=(e.clientX-t.left)*l-v,a=(e.clientY-t.top)*r-v,h=(b.width-v*2)/(s-1),y=Math.round(i/h),u=Math.round(a/h);y>=0&&y<s&&u>=0&&u<s?(g.x!==y||g.y!==u)&&(g={x:y,y:u},b.style.cursor="pointer",m()):g.x!==-1&&(g={x:-1,y:-1},b.style.cursor="default",m())}),b.addEventListener("mouseleave",()=>{g={x:-1,y:-1},m()}),b.addEventListener("click",e=>{if(A==="SOLVE"&&z){S("Tekrar denemek için 'Yenile' butonuna basın.","#e74c3c");return}if(g.x===-1)return;const t=g.x,l=g.y;if(q){p[t][l]?p[t][l]=null:p[t][l]=P++,m();return}if(A==="SETUP")n[t][l]=n[t][l]&&n[t][l].color===f?null:{color:f},m();else if(A==="RECORD"){if(n[t][l])return;const r=JSON.stringify(n),i=f;if(!x(t,l,f))return;let a=c.children.find(h=>h.x===t&&h.y===l);if(a)B.push({node:c,stonesSnapshot:r,turn:i}),c=a,S("Mevcut dalda ilerlendi.","#3498db");else{const h={x:t,y:l,color:f,children:[],status:null};c.children.push(h),B.push({node:c,stonesSnapshot:r,turn:i}),c=h,S("Yeni varyasyon kaydediliyor...","#f1c40f")}f=f==="black"?"white":"black",m()}else if(A==="SOLVE"){if(!L){x(t,l,f)&&(f=f==="black"?"white":"black",m(),S("Analiz Modu","#3498db"));return}const r=c.children.find(i=>i.x===t&&i.y===l);r?(x(t,l,r.color),c=r,f=f==="black"?"white":"black",m(),V(c),c.children&&c.children.length>0&&!c.status&&setTimeout(()=>{const i=c.children[0];x(i.x,i.y,i.color),c=i,f=f==="black"?"white":"black",m(),V(c)},500)):(S("Tanımsız hamle. (Yanlış olabilir)","#e74c3c"),z=!0,d.classList.add("locked"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!1))}});function V(e){if(e.status==="correct"){j();return}if(e.status==="wrong"){F();return}(!e.children||e.children.length===0)&&j()}function j(){S("Tebrikler! Doğru Çözüm.","#2ecc71"),z=!0,d.classList.add("locked"),Y()}function F(){S("Yanlış yol! (Yenile butonuna basınız)","#e74c3c"),z=!0,d.classList.add("locked"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!1)}if(T){d.querySelector("#undoBtn")?.addEventListener("click",()=>{if(B.length>0){const t=B.pop();c=t.node,n=JSON.parse(t.stonesSnapshot),f=t.turn,S("Geri alındı.","#fff"),m()}}),d.querySelector("#markCorrectBtn")?.addEventListener("click",()=>{c!==k&&(c.status="correct",S("Bu dal 'DOĞRU' işaretlendi.","#2ecc71"))}),d.querySelector("#markWrongBtn")?.addEventListener("click",()=>{c!==k&&(c.status="wrong",S("Bu dal 'YANLIŞ' işaretlendi.","#e74c3c"))}),d.querySelector(".setupBtn")?.addEventListener("click",()=>H("SETUP")),d.querySelector(".recordBtn")?.addEventListener("click",()=>H("RECORD")),d.querySelector(".exportBtn")?.addEventListener("click",()=>{const t=prompt("Soru Başlığı (Title):","Yeni Go Sorusu")||"İsimsiz Soru",l=prompt("Kategori (örn: Yaşam/Ölüm):","Genel")||"Genel",r=prompt("Açıklama (Description):","Siyah oynar ve kazanır.")||"",i={id:`prob-${Date.now()}`,size:s,labels:JSON.stringify(p),turn:$,title:t,category:l,description:r,initialState:w||JSON.stringify(n),solution:k},h=JSON.stringify(i,null,2).replace(/"(\w+)":/g,"$1:");console.log(h),alert("TypeScript formatında veri hazır! Console'u (F12) açıp kopyalayabilirsiniz.")});const e=d.querySelector(".colorToggleBtn");e&&e.addEventListener("click",()=>{f=f==="black"?"white":"black";const t=document.getElementById("teacherColorIndicator");t&&(t.classList.toggle("black"),t.classList.toggle("white"))})}const H=e=>{if(e==="SETUP"){if(w){const t=JSON.parse(w);Array.isArray(t)&&Array.isArray(t[0])&&(n=t),k={children:[]},c=k,B=[]}S("Taşları dizin.","#fff")}e==="RECORD"&&A==="SETUP"&&(w=JSON.stringify(n),$=f,k={children:[]},c=k,B=[],S("Kayıt Başladı.","#f1c40f")),A=e,d.querySelectorAll(".control-btn").forEach(t=>t.classList.remove("active")),e==="SETUP"&&d.querySelector(".setupBtn")?.classList.add("active"),e==="RECORD"&&d.querySelector(".recordBtn")?.classList.add("active")};d.querySelector(".resetBtn")?.addEventListener("click",()=>{if(S("","#fff"),z=!1,d.classList.remove("locked"),p=Array(s).fill(0).map(()=>Array(s).fill(null)),P=1,q=!1,d.querySelector(".labelBtn")?.classList.remove("active"),C=[],T&&A==="SETUP")N(s);else{const e=M?JSON.parse(M):{};if(e.turn?f=e.turn:f="black",w){const t=JSON.parse(w);Array.isArray(t)&&Array.isArray(t[0])?n=t:(N(s),Array.isArray(t)&&t.forEach(l=>{l&&(n[l.x][l.y]={color:l.color})}))}else N(s);e.labels&&(p=typeof e.labels=="string"?JSON.parse(e.labels):e.labels),c=k,B=[],!T&&!L&&(S("Analiz Modu","#3498db"),Y())}m()});const R=d.querySelector(".labelBtn");R&&R.addEventListener("click",()=>{q=!q,q?(R.classList.add("active"),S(`Etiket Modu: ${P}'den başlıyor`,"#000")):(R.classList.remove("active"),S("Mod kapatıldı.","#fff"))}),window.resetAllBoards||(window.resetAllBoards=()=>{document.querySelectorAll(".resetBtn").forEach(t=>{t instanceof HTMLElement&&t.click()})}),d.setAttribute("data-initialized","true"),m()})};document.addEventListener("astro:page-load",K);document.addEventListener("DOMContentLoaded",K);
