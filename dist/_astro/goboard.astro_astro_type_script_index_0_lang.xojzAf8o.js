const U=()=>{document.querySelectorAll(".go-app").forEach(S=>{if(S.getAttribute("data-initialized"))return;const d=S.querySelector(".goBoard"),C=S.querySelector(".status"),L=S.getAttribute("data-teacher")==="true",r=d.getContext("2d",{alpha:!1});if(!r)return;let f=9;const w=2,T=500;let b=30*w,A=L?"SETUP":"SOLVE",l=[],u="black",m="",P="black",v={children:[]},c=v,p=[],y={x:-1,y:-1};d.width=T*w,d.height=T*w,d.style.width=`${T}px`,d.style.height=`${T}px`;const B=t=>{l=Array(t).fill(0).map(()=>Array(t).fill(null))};B(f);const N=(t,e)=>t>=0&&t<f&&e>=0&&e<f,R=(t,e,o,i=new Set)=>{const n=`${t},${e}`;if(i.has(n))return 0;i.add(n);let h=0;return[[t+1,e],[t-1,e],[t,e+1],[t,e-1]].forEach(([a,g])=>{if(!N(a,g))return;const z=l[a][g];z?z.color===o&&(h+=R(a,g,o,i)):h++}),h},D=(t,e,o)=>{const i=l[t][e];if(!i||i.color!==o)return;l[t][e]=null,[[t+1,e],[t-1,e],[t,e+1],[t,e-1]].forEach(([h,s])=>{N(h,s)&&D(h,s,o)})},q=(t,e,o)=>{if(l[t][e])return!1;l[t][e]={color:o};let i=!1;const n=o==="black"?"white":"black";return[[t+1,e],[t-1,e],[t,e+1],[t,e-1]].forEach(([s,a])=>{N(s,a)&&l[s][a]&&l[s][a].color===n&&R(s,a,n)===0&&(D(s,a,n),i=!0)}),!i&&R(t,e,o)===0?(l[t][e]=null,E("İntihar hamlesi yasak!","#e74c3c"),!1):!0},O=S.getAttribute("data-problem");if(O)try{const t=JSON.parse(O);if(f=t.size||9,B(f),t.turn?u=t.turn:u="black",t.initialState){m=t.initialState;const e=JSON.parse(t.initialState);Array.isArray(e)&&(Array.isArray(e[0])?l=e:e.forEach(o=>{o&&o.x!==void 0&&(l[o.x][o.y]={color:o.color})}))}if(t.solution)if(Array.isArray(t.solution)){let e=v;t.solution.forEach(o=>{const i={...o,children:[],status:null};e.children.push(i),e=i}),e.status="correct"}else v=t.solution;c=v,L||(A="SOLVE")}catch(t){console.error(t)}const k=()=>{r.fillStyle="#eebb66",r.fillRect(0,0,d.width,d.height);const t=(d.width-b*2)/(f-1);r.lineWidth=1.5*w,r.strokeStyle="#000",r.beginPath();for(let o=0;o<f;o++){const i=Math.round(b+o*t);r.moveTo(i,b),r.lineTo(i,d.height-b),r.moveTo(b,i),r.lineTo(d.width-b,i),r.fillStyle="#000",r.font=`bold ${12*w}px sans-serif`,r.textAlign="center",r.textBaseline="middle";const n=String.fromCharCode(65+(o>=8?o+1:o));r.fillText(n,i,d.height-10*w),r.fillText((f-o).toString(),15*w,i)}r.stroke();const e=f===19?[3,9,15]:f===13?[3,6,9]:[2,4,6];f>=9&&(r.fillStyle="#000",e.forEach(o=>{e.forEach(i=>{r.beginPath(),r.arc(b+o*t,b+i*t,3*w,0,Math.PI*2),r.fill()})})),l.forEach((o,i)=>o.forEach((n,h)=>{n&&M(i,h,n.color,t,1)})),y.x>=0&&y.x<f&&y.y>=0&&y.y<f&&(l[y.x][y.y]||M(y.x,y.y,u,t,.5))},M=(t,e,o,i,n)=>{const h=b+t*i,s=b+e*i,a=i*.48;if(r.save(),r.globalAlpha=n,n===1&&(r.shadowColor="rgba(0,0,0,0.3)",r.shadowBlur=3*w,r.shadowOffsetX=1*w,r.shadowOffsetY=1*w),r.beginPath(),r.arc(h,s,a,0,Math.PI*2),o==="black"){const g=r.createRadialGradient(h-a*.3,s-a*.3,a*.1,h,s,a);g.addColorStop(0,"#555"),g.addColorStop(1,"#000"),r.fillStyle=g}else{const g=r.createRadialGradient(h-a*.3,s-a*.3,a*.1,h,s,a);g.addColorStop(0,"#fff"),g.addColorStop(1,"#ddd"),r.fillStyle=g}r.fill(),o==="white"&&n===1&&(r.lineWidth=1,r.strokeStyle="#ccc",r.stroke()),r.restore()};d.addEventListener("mousemove",t=>{const e=d.getBoundingClientRect(),o=d.width/e.width,i=d.height/e.height,n=(t.clientX-e.left)*o-b,h=(t.clientY-e.top)*i-b,s=(d.width-b*2)/(f-1),a=Math.round(n/s),g=Math.round(h/s);a>=0&&a<f&&g>=0&&g<f?(y.x!==a||y.y!==g)&&(y={x:a,y:g},d.style.cursor="pointer",k()):y.x!==-1&&(y={x:-1,y:-1},d.style.cursor="default",k())}),d.addEventListener("mouseleave",()=>{y={x:-1,y:-1},k()}),d.addEventListener("click",t=>{if(y.x===-1)return;const e=y.x,o=y.y;if(A==="SETUP")l[e][o]=l[e][o]&&l[e][o].color===u?null:{color:u},k();else if(A==="RECORD"){if(l[e][o])return;const i=JSON.stringify(l),n=u;if(!q(e,o,u))return;let h=c.children.find(s=>s.x===e&&s.y===o);if(h)p.push({node:c,stonesSnapshot:i,turn:n}),c=h,E("Mevcut dalda ilerlendi.","#3498db");else{const s={x:e,y:o,color:u,children:[],status:null};c.children.push(s),p.push({node:c,stonesSnapshot:i,turn:n}),c=s,E("Yeni varyasyon kaydediliyor...","#f1c40f")}u=u==="black"?"white":"black",k()}else if(A==="SOLVE"){const i=c.children.find(n=>n.x===e&&n.y===o);i?(q(e,o,i.color),c=i,u=u==="black"?"white":"black",k(),x(c),c.children.length>0&&!c.status&&setTimeout(()=>{const n=c.children[0];q(n.x,n.y,n.color),c=n,u=u==="black"?"white":"black",k(),x(c)},500)):(E("Tanımsız hamle. (Yanlış olabilir)","#e74c3c"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!1))}});function x(t){t.status==="correct"?(E("Tebrikler! Doğru Çözüm.","#2ecc71"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!0),typeof window.unlockNextButton=="function"&&window.unlockNextButton()):t.status==="wrong"&&(E("Yanlış yol! Başarısız.","#e74c3c"),typeof window.handleMoveResult=="function"&&window.handleMoveResult(!1))}function E(t,e){C&&(C.innerText=t,C.style.color=e)}if(L){S.querySelector("#undoBtn")?.addEventListener("click",()=>{if(p.length>0){const e=p.pop();c=e.node,l=JSON.parse(e.stonesSnapshot),u=e.turn,E("Geri alındı.","#fff"),k()}}),S.querySelector("#markCorrectBtn")?.addEventListener("click",()=>{c!==v&&(c.status="correct",E("Bu dal 'DOĞRU' işaretlendi.","#2ecc71"))}),S.querySelector("#markWrongBtn")?.addEventListener("click",()=>{c!==v&&(c.status="wrong",E("Bu dal 'YANLIŞ' işaretlendi.","#e74c3c"))}),S.querySelector(".setupBtn")?.addEventListener("click",()=>J("SETUP")),S.querySelector(".recordBtn")?.addEventListener("click",()=>J("RECORD")),S.querySelector(".exportBtn")?.addEventListener("click",()=>{const e={id:`prob-${Date.now()}`,size:f,turn:P,initialState:m||JSON.stringify(l),solution:v};console.log(JSON.stringify(e,null,2)),alert("Ağaç yapısı (Tree) Console'a yazdırıldı!")});const t=S.querySelector(".colorToggleBtn");t&&t.addEventListener("click",()=>{u=u==="black"?"white":"black";const e=document.getElementById("teacherColorIndicator");e&&(e.classList.toggle("black"),e.classList.toggle("white"))})}const J=t=>{if(t==="SETUP"){if(m){const e=JSON.parse(m);Array.isArray(e)&&Array.isArray(e[0])&&(l=e),v={children:[]},c=v,p=[]}E("Taşları dizin.","#fff")}t==="RECORD"&&A==="SETUP"&&(m=JSON.stringify(l),P=u,v={children:[]},c=v,p=[],E("Kayıt Başladı.","#f1c40f")),A=t,S.querySelectorAll(".control-btn").forEach(e=>e.classList.remove("active")),t==="SETUP"&&S.querySelector(".setupBtn")?.classList.add("active"),t==="RECORD"&&S.querySelector(".recordBtn")?.classList.add("active")};S.querySelector(".resetBtn")?.addEventListener("click",()=>{if(E("","#fff"),L&&A==="SETUP")B(f);else{const t=O?JSON.parse(O):{};if(t.turn?u=t.turn:u="black",m){const e=JSON.parse(m);Array.isArray(e)&&Array.isArray(e[0])?l=e:(B(f),Array.isArray(e)&&e.forEach(o=>{o&&(l[o.x][o.y]={color:o.color})}))}else B(f);c=v,p=[]}k()}),S.setAttribute("data-initialized","true"),k()})};document.addEventListener("astro:page-load",U);document.addEventListener("DOMContentLoaded",U);
