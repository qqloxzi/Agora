---
// components/goboard.astro
const { problem, isTeacher = false } = Astro.props;
---

<div class="go-app" data-problem={problem ? JSON.stringify(problem) : null} data-teacher={isTeacher.toString()}>
  
  <div class="controls">
    {isTeacher ? (
      <>
        <div class="teacher-tools">
          <select class="boardSizeSelect">
            <option value="9">9x9 Board</option>
            <option value="13">13x13 Board</option>
            <option value="19">19x19 Board</option>
          </select>
          <button class="colorToggleBtn active-black">Current: Black</button>
        </div>
        <div class="action-buttons">
          <button class="setupBtn active">1. Setup Layout</button>
          <button class="recordBtn">2. Record Solution</button>
          <button class="exportBtn" style="background: #2ecc71; color: white;">Export JSON</button>
          <button class="resetBtn" style="background: #e74c3c; color: white; border-color: #c0392b;">Clear All</button>
        </div>
      </>
    ) : (
      <>
        <button class="resetBtn">Tekrar Dene</button>
      </>
    )}
  </div>

  <div class="status"></div>

  <div class="go-container">
    <canvas class="goBoard" width="550" height="550"></canvas>
  </div>
</div>

<style>
  .go-app { text-align: center; margin-bottom: 2rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  .controls { display: flex; flex-direction: column; gap: 12px; margin-bottom: 10px; align-items: center; }
  .teacher-tools, .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
  
  /* Status (Durum Mesajı) Stili */
  .status { 
    font-size: 1.1rem; 
    font-weight: bold; 
    margin-bottom: 10px; 
    height: 1.5em;
    color: #ecf0f1; /* Koyu lacivert yerine açık gri/beyaz yaptık */
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    transition: color 0.3s ease;
  }

  button, select {
    padding: 10px 18px;
    cursor: pointer;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
    /* Varsayılan sınırları kaldırıp özelleştireceğiz */
    border: none; 
    outline: none;
  }
  .resetBtn {
    background-color: rgba(255, 255, 255, 0.1); /* Şeffafımsı beyaz */
    border: 1px solid rgba(255, 255, 255, 0.3); /* İnce beyaz çerçeve */
    color: #ffffff; /* Beyaz yazı */
    font-size: 0.9rem;
    margin-bottom: 15px; /* Tahta ile arası mesafe */
  }

  .resetBtn:hover {
    background-color: rgba(255, 255, 255, 0.25); /* Üzerine gelince parlasın */
    transform: translateY(-2px);
  }
  
  .colorToggleBtn.active-black { background: #2c3e50; color: #fff; border-color: #000; }
  .colorToggleBtn.active-white { background: #ecf0f1; color: #2c3e50; border-color: #bdc3c7; }
  
  button.active { background: #f39c12; color: white; border-color: #e67e22; }
  
  .go-container { 
    display: inline-flex; 
    padding: 10px;
    background-color: #eebb66;
    border-radius: 8px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    border: 1px solid #d4a753;
  }
  
  canvas { cursor: none; display: block; }
</style>

<script>
  const setupBoard = () => {
    document.querySelectorAll('.go-app').forEach(app => {
      if (app.getAttribute('data-initialized')) return;
      
      const canvas = app.querySelector('.goBoard') as HTMLCanvasElement;
      // Status div'ini seçiyoruz (Artık HTML'de var)
      const statusDiv = app.querySelector('.status') as HTMLElement;
      
      const isTeacher = app.getAttribute('data-teacher') === 'true';
      const ctx = canvas.getContext('2d');
      if (!ctx) return;

      // --- AYARLAR ---
      let size = 9; 
      let padding = 30; 
      // ---------------

      let mode = isTeacher ? 'SETUP' : 'SOLVE';
      let currentColor: 'black' | 'white' = 'black';
      let stones: any[][] = [];
      let solution: any[] = [];
      let solveIndex = 0;
      let initialStonesState = "";
      
      // Mouse Takibi
      let hoverPos = { x: -1, y: -1 };

      const initStones = (newSize) => {
        stones = Array(newSize).fill(null).map(() => Array(newSize).fill(null));
      };

      initStones(size);

      const savedData = app.getAttribute('data-problem');
      if (savedData) {
        const prob = JSON.parse(savedData);
        size = prob.size || 9;
        initStones(size);
        initialStonesState = prob.initialState;
        stones = JSON.parse(initialStonesState);
        solution = prob.solution;
        if (!isTeacher) mode = 'SOLVE';
      }

      const drawBoard = () => {
        const cellSize = (canvas.width - padding * 2) / (size - 1);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Zemin
        const grd = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        grd.addColorStop(0, "#f5cf7c");
        grd.addColorStop(1, "#eebb66");
        ctx.fillStyle = grd;
        ctx.fillRect(0,0, canvas.width, canvas.height);

        // Çizgiler
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#000';
        ctx.beginPath();
        for (let i = 0; i < size; i++) {
          const pos = Math.round(padding + i * cellSize) + 0.5;
          ctx.moveTo(pos, padding); ctx.lineTo(pos, canvas.height - padding);
          ctx.moveTo(padding, pos); ctx.lineTo(canvas.width - padding, pos);
          
          ctx.fillStyle = '#443322'; 
          ctx.font = `bold ${size > 13 ? '10px' : '12px'} sans-serif`;
          ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
          const label = String.fromCharCode(65 + (i >= 8 ? i + 1 : i));
          ctx.fillText(label, pos, canvas.height - 10);
          ctx.fillText((size - i).toString(), 15, pos);
        }
        ctx.stroke();

        // Yıldızlar
        const hoshiCoords = size === 19 ? [3, 9, 15] : size === 13 ? [3, 6, 9] : [2, 4, 6];
        if (size >= 9) {
          hoshiCoords.forEach(hx => {
            hoshiCoords.forEach(hy => {
              ctx.beginPath();
              ctx.arc(padding + hx * cellSize, padding + hy * cellSize, 3.5, 0, Math.PI * 2);
              ctx.fillStyle = '#000'; ctx.fill();
            });
          });
        }

        // Taşlar
        stones.forEach((row, x) => row.forEach((stone, y) => {
          if (stone) drawStone(x, y, stone.color, cellSize, 1);
        }));

        // GHOST STONE (Önizleme)
        if (hoverPos.x >= 0 && hoverPos.x < size && hoverPos.y >= 0 && hoverPos.y < size) {
          if (!stones[hoverPos.x][hoverPos.y]) {
            let ghostColor = currentColor;
            if (mode === 'SOLVE') {
               if (solution[solveIndex]) {
                 ghostColor = solution[solveIndex].color;
               } else {
                 ghostColor = 'black'; 
               }
            }
            drawStone(hoverPos.x, hoverPos.y, ghostColor, cellSize, 0.5);
          }
        }
      };

      const drawStone = (x, y, color, cellSize, opacity) => {
        const posX = padding + x * cellSize;
        const posY = padding + y * cellSize;
        const radius = cellSize * 0.48;

        ctx.save();
        ctx.globalAlpha = opacity;
        ctx.beginPath();
        ctx.arc(posX, posY, radius, 0, Math.PI * 2);

        if (color === 'black') {
          const grad = ctx.createRadialGradient(posX - radius/3, posY - radius/3, radius/5, posX, posY, radius);
          grad.addColorStop(0, "#555"); grad.addColorStop(1, "#000");
          ctx.fillStyle = grad;
        } else {
          const grad = ctx.createRadialGradient(posX - radius/3, posY - radius/3, radius/5, posX, posY, radius);
          grad.addColorStop(0, "#fff"); grad.addColorStop(1, "#ddd");
          ctx.fillStyle = grad;
          ctx.strokeStyle = '#aaa'; ctx.lineWidth = 1; ctx.stroke();
        }
        ctx.fill();
        ctx.restore();
      };

      // --- Event Listeners ---

      canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        const cellSize = (canvas.width - padding * 2) / (size - 1);
        const x = Math.round((e.clientX - rect.left - padding) / cellSize);
        const y = Math.round((e.clientY - rect.top - padding) / cellSize);

        if (x >= 0 && x < size && y >= 0 && y < size) {
            if (hoverPos.x !== x || hoverPos.y !== y) {
                hoverPos = { x, y };
                canvas.style.cursor = 'pointer';
                drawBoard();
            }
        } else {
            if (hoverPos.x !== -1) {
                hoverPos = { x: -1, y: -1 };
                canvas.style.cursor = 'default';
                drawBoard();
            }
        }
      });

      canvas.addEventListener('mouseleave', () => {
        hoverPos = { x: -1, y: -1 };
        drawBoard();
      });

      canvas.addEventListener('click', (e) => {
        const cellSize = (canvas.width - padding * 2) / (size - 1);
        const rect = canvas.getBoundingClientRect();
        const x = Math.round((e.clientX - rect.left - padding) / cellSize);
        const y = Math.round((e.clientY - rect.top - padding) / cellSize);
        
        if (x < 0 || x >= size || y < 0 || y >= size) return;

        if (mode === 'SETUP') {
          stones[x][y] = stones[x][y] && stones[x][y].color === currentColor ? null : { color: currentColor };
        } else if (mode === 'RECORD') {
          if (!stones[x][y]) {
            stones[x][y] = { color: currentColor };
            solution.push({ x, y, color: currentColor });
          }
        } else if (mode === 'SOLVE') {
          const move = solution[solveIndex];
          if (move && x === move.x && y === move.y) {
            stones[x][y] = { color: move.color };
            solveIndex++;
            
            // DOĞRU HAMLE
            if (statusDiv) {
                statusDiv.innerText = "Doğru!";
                statusDiv.style.color = "#27ae60"; // Yeşil
            }

            if (solveIndex === solution.length) {
              if (statusDiv) statusDiv.innerText = "Tebrikler! Çözüldü.";
              if (typeof (window as any).unlockNextButton === 'function') {
                  (window as any).unlockNextButton();
              }
            }
          } else {
            // HATALI HAMLE
            if (statusDiv) {
                statusDiv.innerText = "Hatalı hamle!";
                statusDiv.style.color = "#c0392b"; // Kırmızı
            }
          }
        }
        drawBoard();
      });

      // Öğretmen Modu
      if (isTeacher) {
        const sizeSelect = app.querySelector('.boardSizeSelect') as HTMLSelectElement;
        sizeSelect.addEventListener('change', (e) => {
          size = parseInt((e.target as HTMLSelectElement).value);
          initStones(size);
          drawBoard();
        });

        const colorBtn = app.querySelector('.colorToggleBtn');
        colorBtn?.addEventListener('click', () => {
          currentColor = currentColor === 'black' ? 'white' : 'black';
          colorBtn.textContent = `Current: ${currentColor.charAt(0).toUpperCase() + currentColor.slice(1)}`;
          colorBtn.classList.toggle('active-black');
          colorBtn.classList.toggle('active-white');
        });
      }

      // Mod Değişimleri (Mod yazılarını temizledik)
      const updateUI = (newMode) => {
        mode = newMode;
        app.querySelectorAll('.action-buttons button').forEach(btn => btn.classList.remove('active'));
        
        if (statusDiv) statusDiv.innerText = ""; // Mod değişince yazıyı temizle

        if (mode === 'SOLVE') {
          stones = JSON.parse(initialStonesState || JSON.stringify(stones));
          solveIndex = 0;
        } else if (mode === 'RECORD') {
          initialStonesState = JSON.stringify(stones);
          solution = [];
          if (statusDiv) statusDiv.innerText = "Kayıt Modu: Hamleleri oynayın";
        } else {
          // SETUP
        }
        drawBoard();
      };

      app.querySelector('.setupBtn')?.addEventListener('click', () => updateUI('SETUP'));
      app.querySelector('.recordBtn')?.addEventListener('click', () => updateUI('RECORD'));
      app.querySelector('.exportBtn')?.addEventListener('click', () => {
        if (solution.length === 0) return alert("Önce çözümü kaydedin!");
        const data = { id: `prob-${Date.now()}`, size, initialState: initialStonesState, solution };
        console.log(JSON.stringify(data, null, 2));
        alert("JSON Console'a yazdırıldı!");
      });

      app.querySelector('.resetBtn')?.addEventListener('click', () => {
         // Reset butonuna basınca yazıyı temizle
         if (statusDiv) {
             statusDiv.innerText = "";
             statusDiv.style.color = "#2c3e50";
         }

         if (isTeacher && mode === 'SETUP') {
           initStones(size);
           solution = [];
         } else {
           stones = JSON.parse(initialStonesState || JSON.stringify(stones));
           solveIndex = 0;
         }
         drawBoard();
      });

      app.setAttribute('data-initialized', 'true');
      drawBoard();
    });
  };

  document.addEventListener('astro:page-load', setupBoard);
  document.addEventListener('DOMContentLoaded', setupBoard);
</script>