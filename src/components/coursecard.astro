---
interface Props {
  course: {
    id: string;
    title: string;
    description: string;
    image_url: string; // Eklendi
    provider: string;  // Eklendi
    rating?: number;   // Eklendi (Opsiyonel)
  };
  currentUserId?: string;
}

const { course } = Astro.props;
---

<a 
  href={`/courses/${course.id}`} 
  class="block bg-white p-3 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow duration-300 relative group h-full text-left"
>
  <div class="flex gap-4 h-full">
    
    <div class="shrink-0">
      <img 
        src={course.image_url || 'https://via.placeholder.com/100'} 
        alt={course.title} 
        class="w-20 h-20 md:w-24 md:h-24 object-cover rounded-lg border border-gray-100"
      />
    </div>

    <div class="flex flex-col justify-between flex-grow">
      <div>
        <div class="flex items-center gap-2 mb-1">
          <div class="w-4 h-4 bg-gray-200 rounded-sm overflow-hidden">
             </div> 
          <span class="text-xs font-semibold text-gray-500">{course.provider}</span>
        </div>
        
        <h3 class="font-bold text-gray-900 text-sm md:text-base leading-snug mb-1 line-clamp-2 group-hover:underline decoration-blue-600 underline-offset-2">
          {course.title}
        </h3>
      </div>

      <div class="flex items-center gap-2 text-xs text-gray-600 mt-2">
        <span class="bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded font-medium">Ders</span>
        {course.rating && (
          <span class="flex items-center gap-1 font-bold text-yellow-600">
            ★ {course.rating}
          </span>
        )}
      </div>
    </div>
  </div>
</a>

<script>
  // Client-side logic to handle the click
  const buttons = document.querySelectorAll('button[id^="btn-"]');

  buttons.forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const courseId = target.dataset.courseId;
      const userId = target.dataset.userId; // Ensure you pass this from the parent or Auth store

      if(!userId) {
        alert("Please login first!");
        return;
      }

      target.innerText = "Joining...";
      target.disabled = true;

      try {
        const res = await fetch("/api/join-course", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ courseId, userId }),
        });

        if (res.ok) {
          target.innerText = "Joined ✅";
        } else {
          target.innerText = "Error ❌";
          target.disabled = false;
        }
      } catch (err) {
        console.error(err);
      }
    });
  });
</script>