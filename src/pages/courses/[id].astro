---
import { supabase } from "../../lib/supabase";
export const prerender = false;

// 1. URL'den ID'yi al (Örn: /courses/123-abc -> id="123-abc")
const { id } = Astro.params;

// 2. Kurs verisini çek
const { data: course, error } = await supabase
  .from("courses")
  .select("*")
  .eq("id", id)
  .single();

// Eğer kurs bulunamazsa 404'e yönlendir veya hata göster
if (!course || error) {
  return Astro.redirect("/404");
}

// 3. Kullanıcı giriş yapmış mı ve ZATEN kayıtlı mı kontrol et
const { data: { user } } = await supabase.auth.getUser();
let isJoined = false;

if (user) {
  const { data: enrollment } = await supabase
    .from("course_enrollments")
    .select("id")
    .eq("user_id", user.id)
    .eq("course_id", id)
    .single();
  
  if (enrollment) isJoined = true;
}
---

<html lang="tr">
  <head>
    <title>{course.title} | Agora Go Akademisi</title>
  </head>
  <body class="bg-[#F5F7F8] font-sans text-gray-800">
    
    <div class="bg-white border-b border-gray-200">
      <div class="max-w-5xl mx-auto px-4 py-8 md:py-12 flex flex-col md:flex-row gap-8 items-start">
        
        <div class="flex-1">
            <a href="/courses" class="text-blue-600 text-sm font-semibold hover:underline mb-4 inline-block">← Tüm Kurslara Dön</a>
            
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">{course.title}</h1>
            
            <p class="text-lg text-gray-600 mb-6">{course.description}</p>
            
            <div class="flex items-center gap-4 text-sm font-medium">
                <div class="flex items-center gap-2">
                    <span class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs">Provider</span>
                    <span>{course.provider}</span>
                </div>
                <div class="hidden md:block w-px h-4 bg-gray-300"></div>
                <div class="text-yellow-600 flex items-center gap-1">
                    <span>★ {course.rating}</span>
                    <span class="text-gray-400 font-normal">(450+ inceleme)</span>
                </div>
            </div>
        </div>

        <div class="w-full md:w-80 bg-white p-6 rounded-xl shadow-lg border border-gray-100 shrink-0">
            <img src={course.image_url} alt={course.title} class="w-full h-40 object-cover rounded-lg mb-4" />
            
            <div class="mb-4">
                <span class="text-2xl font-bold text-gray-900">Ücretsiz</span>
            </div>

            {isJoined ? (
                <button disabled class="w-full py-3 bg-green-600 text-white font-bold rounded-lg cursor-default">
                    Zaten Kayıtlısınız ✅
                </button>
            ) : (
                <button 
                    id="join-btn" 
                    data-course-id={course.id}
                    data-user-id={user?.id}
                    class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors"
                >
                    Şimdi Katıl
                </button>
            )}
            
            <p class="text-xs text-center text-gray-500 mt-3">Herhangi bir zamanda iptal edilebilir.</p>
        </div>

      </div>
    </div>

    <div class="max-w-5xl mx-auto px-4 py-8">
        <div class="max-w-3xl">
            <h2 class="text-2xl font-bold mb-4">Bu derste neler öğreneceksiniz?</h2>
            <div class="prose prose-blue text-gray-600">
                <p>Buraya dersin detaylı müfredatı veya uzun açıklaması gelebilir. Şimdilik veritabanındaki kısa açıklamayı tekrar gösteriyoruz, ancak ileride 'content' adında uzun bir metin alanı ekleyebilirsin.</p>
                <p>{course.description}</p>
            </div>
        </div>
    </div>

    <script>
        const btn = document.getElementById('join-btn');
        if (btn) {
            btn.addEventListener('click', async () => {
                const courseId = btn.getAttribute('data-course-id');
                const userId = btn.getAttribute('data-user-id');

                if (!userId) {
                    alert("Lütfen önce giriş yapın!");
                    window.location.href = "/login"; // Login sayfana yönlendir
                    return;
                }

                btn.innerText = "İşleniyor...";
                // @ts-ignore
                btn.disabled = true;

                try {
                    const res = await fetch("/api/join-course", {
                        method: "POST",
                        body: JSON.stringify({ courseId, userId }),
                    });

                    if (res.ok) {
                        btn.innerText = "Başarıyla Kayıt Olundu! Yönlendiriliyorsunuz...";
                        btn.classList.remove('bg-blue-600');
                        btn.classList.add('bg-green-600');
                        // İstersen burada ders içeriğine yönlendirebilirsin
                        // window.location.href = `/lessons/${courseId}`;
                        setTimeout(() => location.reload(), 1500); // Sayfayı yenile ki buton "Kayıtlısın" olsun
                    } else {
                        btn.innerText = "Hata Oluştu";
                        // @ts-ignore
                        btn.disabled = false;
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        }
    </script>
  </body>
</html>