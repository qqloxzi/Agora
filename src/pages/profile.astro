---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Profilim | Agora Go Akademisi">
  <div class="profile-container">
    <div class="profile-card">
      
      <div class="profile-header">
        <div class="avatar-circle">
           <span id="avatar-initial">?</span>
        </div>
        <h1 id="display-username">Yükleniyor...</h1>
        <p id="display-email" class="email-text">...</p>
      </div>

      <div class="rank-display-section">
        <div class="rank-badge-container">
            <span class="rank-title">Mevcut Seviye</span>
            <div class="rank-value" id="display-rank">20 Kyu</div>
        </div>
        
        <div class="xp-container">
            <div class="xp-info">
                <span id="current-xp">0 XP</span>
                <span id="next-rank-info">Sonraki seviyeye devam et</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="xp-bar" style="width: 0%"></div>
            </div>
        </div>
      </div>

      <div class="profile-info">
        <div class="info-item">
          <span class="label">Kayıt Tarihi</span>
          <span id="info-date" class="value">-</span>
        </div>
        <div class="info-item">
          <span class="label">Hesap Durumu</span>
          <span class="value active-status">Aktif Üye</span>
        </div>
      </div>

      <div class="profile-actions">
        <button id="logout-btn" class="btn-danger">Oturumu Kapat</button>
      </div>

    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../lib/supabase';

  async function initProfile() {
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      window.location.href = '/signup';
      return;
    }

    // DOM Elemanları
    const els = {
        username: document.getElementById('display-username'),
        email: document.getElementById('display-email'),
        avatarInitial: document.getElementById('avatar-initial'),
        infoDate: document.getElementById('info-date'),
        displayRank: document.getElementById('display-rank'),
        currentXp: document.getElementById('current-xp'),
        xpBar: document.getElementById('xp-bar')
    };

    if (els.email) els.email.textContent = user.email || "";

    // KULLANICI VERİSİNİ ÇEK
    const { data: profile, error } = await supabase
      .from('agorasusers')
      .select('*')
      .eq('id', user.id)
      .single();

    if (error) console.error('Profil hatası:', error);

    const displayName = profile?.username || user.email?.split('@')[0] || "Oyuncu";
    
    // UI Güncelleme
    if (els.username) els.username.textContent = displayName;
    if (els.infoDate && profile?.created_at) els.infoDate.textContent = new Date(profile.created_at).toLocaleDateString('tr-TR');
    if (els.avatarInitial) els.avatarInitial.textContent = (displayName[0] || '?').toUpperCase();

    // --- RÜTBE VE XP GÖSTERİMİ ---
    if (profile) {
        // Rütbe (Veritabanından ne gelirse o, değiştirilemez)
        if (els.displayRank) els.displayRank.textContent = profile.rank || "20 Kyu";
        
        // XP (Görsel Bar Hesaplama)
        // Not: Basit bir görselleştirme için modülo kullanıyoruz.
        // Veritabanındaki mantığa (SQL) göre her seviye ortalama 100-200 XP civarı artıyor.
        // Burada barı temsili dolduracağız.
        const totalXP = profile.xp || 0;
        if (els.currentXp) els.currentXp.textContent = `${totalXP} XP`;
        
        // Barın doluluk oranı (Sürekli dönen bir bar yerine, 1000'lik dilimler halinde gösterebiliriz veya sabit)
        // Basitlik için: Bar her zaman biraz dolu görünsün.
        if (els.xpBar) {
            // Sonraki level için kalan (tahmini)
            const fillPercentage = (totalXP % 100); 
            // Kullanıcı ilerledikçe barın dolduğunu hissetmesi için basit matematik
            els.xpBar.style.width = `${Math.max(10, fillPercentage)}%`;
        }
    }
  }

  // Çıkış İşlemi
  const logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
          await supabase.auth.signOut();
          window.location.href = '/signup';
      });
  }

  initProfile();
</script>

<style>
  /* GENEL DÜZEN */
  .profile-container { 
      max-width: 480px; 
      margin: 4rem auto; 
      padding: 0 1.5rem; 
      font-family: 'Inter', sans-serif; 
  }

  .profile-card { 
      background: white; 
      padding: 3rem 2rem; 
      border-radius: 24px; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      border: 1px solid #f1f5f9;
      text-align: center; 
  }

  /* HEADER */
  .avatar-circle { 
      width: 80px; 
      height: 80px; 
      background: #0f172a; 
      margin: 0 auto 1rem; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 2rem; 
      color: white; 
      font-weight: 600; 
  }

  h1 { font-size: 1.25rem; color: #0f172a; margin-bottom: 0.25rem; font-weight: 700; }
  .email-text { color: #64748b; font-size: 0.875rem; margin-bottom: 2rem; }

  /* RANK & XP BÖLÜMÜ (YENİ) */
  .rank-display-section {
      background: #f8fafc;
      padding: 1.5rem;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      margin-bottom: 2rem;
      text-align: center;
  }

  .rank-title { display: block; font-size: 0.8rem; color: #64748b; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
  .rank-value { font-size: 2rem; font-weight: 800; color: #0f172a; margin-bottom: 1rem; }

  .xp-container { margin-top: 1rem; }
  .xp-info { display: flex; justify-content: space-between; font-size: 0.8rem; color: #64748b; margin-bottom: 0.5rem; font-weight: 500; }
  
  .progress-track {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
  }
  
  .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #2563eb);
      border-radius: 10px;
      transition: width 0.5s ease;
  }

  /* BİLGİ LİSTESİ */
  .profile-info { margin-bottom: 2.5rem; border-top: 1px solid #f1f5f9; padding-top: 1.5rem; }
  .info-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.9rem; }
  .info-item:last-child { margin-bottom: 0; }
  .label { color: #64748b; }
  .value { color: #0f172a; font-weight: 500; }
  
  .active-status { display: inline-flex; align-items: center; gap: 6px; }
  .active-status::before { content: ''; display: block; width: 8px; height: 8px; background: #10b981; border-radius: 50%; }

  /* BUTTON */
  .btn-danger { width: 100%; padding: 0.85rem; border: none; border-radius: 12px; background: #fee2e2; color: #ef4444; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
  .btn-danger:hover { background: #fecaca; color: #dc2626; }

  /* DARK MODE */
  :global(body.dark) .profile-card { background: #1e293b; border-color: #334155; }
  :global(body.dark) h1, :global(body.dark) .value, :global(body.dark) .rank-value { color: #f8fafc; }
  :global(body.dark) .rank-display-section { background: #0f172a; border-color: #334155; }
  :global(body.dark) .rank-title, :global(body.dark) .xp-info { color: #cbd5e1; }
  :global(body.dark) .progress-track { background: #334155; }
  :global(body.dark) .btn-danger { background: #450a0a; color: #fca5a5; }
</style>