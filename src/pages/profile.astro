---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Profilim | Agora Go Akademisi">
  <div class="profile-container">
    <div class="profile-card">
      
      <div class="profile-header">
        <div class="avatar-circle">
           <span id="avatar-initial">?</span>
        </div>
        <h1 id="display-username">Yükleniyor...</h1>
        <p id="display-email" class="email-text">...</p>
      </div>

      <div class="rank-section">
        <label for="rank-select" class="rank-label">Go Seviyesi</label>
        <div class="select-wrapper">
            <select id="rank-select" class="rank-dropdown">
                <option value="" disabled selected>Seviyeni Seç</option>
                </select>
            <span class="select-arrow">▼</span>
        </div>
        <p class="rank-hint">Seviyeni güncellediğinde sistem otomatik olarak kaydeder.</p>
      </div>

      <div class="profile-info">
        <div class="info-item">
          <span class="label">Kayıt Tarihi</span>
          <span id="info-date" class="value">-</span>
        </div>
        <div class="info-item">
          <span class="label">Hesap Durumu</span>
          <span class="value active-status">Aktif Üye</span>
        </div>
      </div>

      <div class="profile-actions">
        <button id="logout-btn" class="btn-danger">Oturumu Kapat</button>
      </div>

    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../lib/supabase';

  // Go Seviyeleri Listesi (20 Kyu -> 1 Kyu -> 1 Dan -> 9 Dan)
const ranks: string[] = [];
  for (let i = 20; i >= 1; i--) ranks.push(`${i} Kyu`);
  for (let i = 1; i <= 9; i++) ranks.push(`${i} Dan`);

  async function initProfile() {
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      window.location.href = '/signup';
      return;
    }

    // DOM Elemanları
    const els = {
        username: document.getElementById('display-username'),
        email: document.getElementById('display-email'),
        avatarInitial: document.getElementById('avatar-initial'),
        infoDate: document.getElementById('info-date'),
        rankSelect: document.getElementById('rank-select') as HTMLSelectElement
    };

    if (els.email) els.email.textContent = user.email || "";

    // KULLANICI VERİSİNİ ÇEK
    const { data: profile, error } = await supabase
      .from('agorasusers')
      .select('*')
      .eq('id', user.id)
      .single();

    if (error) console.error('Profil hatası:', error);

    const displayName = profile?.username || user.email?.split('@')[0] || "Oyuncu";
    
    // UI Güncelleme
    if (els.username) els.username.textContent = displayName;
    if (els.infoDate && profile?.created_at) els.infoDate.textContent = new Date(profile.created_at).toLocaleDateString('tr-TR');
    if (els.avatarInitial) els.avatarInitial.textContent = (displayName[0] || '?').toUpperCase();

    // --- RANK SEÇİCİ MANTIĞI ---
    if (els.rankSelect) {
        // 1. Seçenekleri Doldur
        ranks.forEach(rank => {
            const option = document.createElement('option');
            option.value = rank;
            option.textContent = rank;
            els.rankSelect.appendChild(option);
        });

        // 2. Mevcut Rütbeyi Seçili Yap
        if (profile?.rank) {
            els.rankSelect.value = profile.rank;
        } else {
            // Varsayılan olarak 20 Kyu yap veya boş bırak
            els.rankSelect.value = "20 Kyu"; 
        }

        // 3. Değişiklik Olduğunda Kaydet
        els.rankSelect.addEventListener('change', async (e) => {
            const target = e.target as HTMLSelectElement;
            const newRank = target.value;
            
            // Kullanıcıya görsel geri bildirim (Kısa süreli renk değişimi)
            target.style.borderColor = "#10b981"; // Yeşil
            
            const { error: updateError } = await supabase
                .from('agorasusers')
                .update({ rank: newRank })
                .eq('id', user.id);

            if (updateError) {
                alert("Seviye güncellenirken hata oluştu.");
                target.style.borderColor = "#ef4444"; // Kırmızı
            } else {
                setTimeout(() => { target.style.borderColor = "#e2e8f0"; }, 1000);
            }
        });
    }
  }

  // Çıkış İşlemi
  const logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
          await supabase.auth.signOut();
          window.location.href = '/signup';
      });
  }

  initProfile();
</script>

<style>
  /* GENEL DÜZEN */
  .profile-container { 
      max-width: 480px; 
      margin: 4rem auto; 
      padding: 0 1.5rem; 
      font-family: 'Inter', sans-serif; 
  }

  .profile-card { 
      background: white; 
      padding: 3rem 2rem; 
      border-radius: 24px; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      border: 1px solid #f1f5f9;
      text-align: center; 
  }

  /* HEADER */
  .avatar-circle { 
      width: 80px; 
      height: 80px; 
      background: #0f172a; 
      margin: 0 auto 1rem; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 2rem; 
      color: white; 
      font-weight: 600; 
  }

  h1 { 
      font-size: 1.25rem; 
      color: #0f172a; 
      margin-bottom: 0.25rem; 
      font-weight: 700; 
  }

  .email-text { 
      color: #64748b; 
      font-size: 0.875rem; 
      margin-bottom: 2rem; 
  }

  /* RANK SEÇİCİ (ÖNEMLİ KISIM) */
  .rank-section {
      margin-bottom: 2.5rem;
      text-align: left;
      background: #f8fafc;
      padding: 1.5rem;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
  }

  .rank-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #334155;
      margin-bottom: 0.5rem;
  }

  .select-wrapper {
      position: relative;
  }

  .rank-dropdown {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      background-color: white;
      color: #0f172a;
      cursor: pointer;
      appearance: none; /* Varsayılan oku gizle */
      font-weight: 500;
      transition: all 0.2s;
  }

  .rank-dropdown:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .select-arrow {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #64748b;
      font-size: 0.8rem;
  }

  .rank-hint {
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: #94a3b8;
  }

  /* BİLGİ LİSTESİ */
  .profile-info { 
      margin-bottom: 2.5rem; 
      border-top: 1px solid #f1f5f9;
      padding-top: 1.5rem;
  }

  .info-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      margin-bottom: 1rem; 
      font-size: 0.9rem;
  }

  .info-item:last-child { margin-bottom: 0; }

  .label { color: #64748b; }
  .value { color: #0f172a; font-weight: 500; }
  
  .active-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
  }
  .active-status::before {
      content: '';
      display: block;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
  }

  /* BUTTON */
  .btn-danger { 
      width: 100%; 
      padding: 0.85rem; 
      border: none; 
      border-radius: 12px; 
      background: #fee2e2; 
      color: #ef4444; 
      font-weight: 600; 
      font-size: 0.9rem;
      cursor: pointer; 
      transition: all 0.2s; 
  }

  .btn-danger:hover { 
      background: #fecaca; 
      color: #dc2626;
  }

  /* DARK MODE */
  :global(body.dark) .profile-card { background: #1e293b; border-color: #334155; }
  :global(body.dark) h1, :global(body.dark) .value { color: #f8fafc; }
  :global(body.dark) .rank-section { background: #0f172a; border-color: #334155; }
  :global(body.dark) .rank-label { color: #cbd5e1; }
  :global(body.dark) .rank-dropdown { background: #1e293b; border-color: #334155; color: white; }
  :global(body.dark) .btn-danger { background: #450a0a; color: #fca5a5; }
  :global(body.dark) .btn-danger:hover { background: #7f1d1d; }
</style>