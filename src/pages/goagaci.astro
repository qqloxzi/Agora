---
// pages/goagaci.astro
import GoBoard from '../components/goboard.astro';
import { problemSet } from '../data/problems';
import Layout from "@layouts/Layout.astro";

// --- 3 KOLONLU AÄAÃ‡ YAPILANDIRMASI ---
const treeColumns = [
  {
    title: "BaÅŸlangÄ±Ã§ (20-18k)",
    colorClass: "beginner",
    levels: [
      [{ id: 'Kurallar', parent: null }],          
      [{ id: 'Esir Alma 1', parent: 'Kurallar' }],   
      [{ id: 'Ä°ki GÃ¶z KavramÄ±', parent: 'Esir Alma 1' }],      
      [{ id: 'Nefes YarÄ±ÅŸÄ±', parent: 'Ä°ki GÃ¶z KavramÄ±' }],         
      [{ id: 'Tesuji 1', parent: 'Nefes YarÄ±ÅŸÄ±' }],       
      [{ id: 'Oyunu Bitirme', parent: 'Tesuji 1' }]   
    ]
  },
  {
    title: "Temel TaÅŸlar (17-12k)",
    colorClass: "intermediate",
    levels: [
      [{ id: 'Ã–lÃ¼m & KalÄ±m 1', parent: null }],      
      [
        { id: 'AÃ§Ä±lÄ±ÅŸ Prensipleri 1', parent: 'Ã–lÃ¼m & KalÄ±m 1' },
        { id: 'AÃ§Ä±lÄ±ÅŸ Prensipleri 2', parent: 'Ã–lÃ¼m & KalÄ±m 1' }
      ],  
      [{ id: 'Sente', parent: 'AÃ§Ä±lÄ±ÅŸ Prensipleri' }],         
      [{ id: 'Åekil', parent: 'Sente' }],          
      [{ id: 'Ko SavaÅŸÄ±', parent: 'Åekil' }],      
      [{ id: 'AÃ§Ä±lÄ±ÅŸ', parent: 'Ko SavaÅŸÄ±' }]      
    ]
  },
  {
    title: "Ä°leri Seviye (11-6k)",
    colorClass: "advanced",
    levels: [
      [{ id: 'Joseki', parent: null }],            
      [{ id: 'Ä°stila', parent: 'Joseki' }],        
      [{ id: 'SaldÄ±rÄ±', parent: 'Ä°stila' }],       
      [{ id: 'Sayma', parent: 'SaldÄ±rÄ±' }],        
      [{ id: 'Yose', parent: 'Sayma' }],           
      [{ id: 'Dan Seviyesi', parent: 'Yose' }]     
    ]
  }
];

const getCategoryStyle = (cat) => {
  const styles = {
    'Kurallar': { icon: 'ğŸ“–', color: '#3498db' },
    'Esir Alma 1': { icon: 'âš—ï¸', color: '#3498db' },
    'Ä°ki GÃ¶z KavramÄ±': { icon: 'ğŸ‘€', color: '#3498db' },
    'Nefes YarÄ±ÅŸÄ±': { icon: '', color: '#3498db' },
    'AÃ§Ä±lÄ±ÅŸ Prensipleri 1': { icon: 'ğŸŒŸ', color: '#f1c40f' },
    'AÃ§Ä±lÄ±ÅŸ Prensipleri 2': { icon: 'ğŸŒŸ', color: '#f1c40f' },
    'Tesuji 1': { icon: 'ğŸ”—', color: '#3498db' },
    'Oyunu Bitirme': { icon: 'ğŸ', color: '#3498db' },
    'Ã–lÃ¼m & KalÄ±m 1': { icon: 'ğŸ’€', color: '#f1c40f' },
    'Tesuji': { icon: 'âš¡', color: '#f1c40f' },
    'Sente': { icon: 'ğŸ—¡ï¸', color: '#f1c40f' },
    'Åekil': { icon: 'ğŸ”º', color: '#f1c40f' },
    'Ko SavaÅŸÄ±': { icon: 'ğŸ”„', color: '#f1c40f' },
    'AÃ§Ä±lÄ±ÅŸ': { icon: 'ğŸŒŸ', color: '#f1c40f' },
    'Joseki': { icon: 'ğŸ“š', color: '#e74c3c' },
    'Ä°stila': { icon: 'ğŸ°', color: '#e74c3c' },
    'SaldÄ±rÄ±': { icon: 'âš”ï¸', color: '#e74c3c' },
    'Sayma': { icon: 'ğŸ§®', color: '#e74c3c' },
    'Yose': { icon: 'ğŸ‚', color: '#e74c3c' },
    'Dan Seviyesi': { icon: 'ğŸ¥‹', color: '#e74c3c' },
  };
  return styles[cat] || { icon: 'Go', color: '#95a5a6' };
};
---

<Layout title="Go AÄŸacÄ± - Yetenek Yolu">
  <div class="page-wrapper">
    
    <h1 class="main-title">Go AÄŸacÄ±</h1>
    <p class="subtitle">Sol menÃ¼den konularÄ± inceleyebilir, saÄŸ taraftaki aÄŸaÃ§tan ilerleyebilirsin.</p>

    <div id="level-map" class="content-grid">
      
      <aside class="sidebar">
        <div class="sidebar-header">
          <h3>Konu Listesi</h3>
        </div>
        <div class="sidebar-content">
          {treeColumns.map(col => (
            <div class="course-group">
              <h4 style={`border-left: 4px solid var(--${col.colorClass}-color, #fff)`}>{col.title}</h4>
              <ul>
                {col.levels.map(lvl => (
                  <li>
                    <span class="dot"></span>
                    {lvl[0].id}
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      </aside>

      <main class="tree-wrapper">
        <div class="columns-container">
          {treeColumns.map((col, colIndex) => (
            <div class={`tree-column ${col.colorClass}`}>
              <div class="column-header">
                <h2>{col.title}</h2>
                <div class="header-line"></div>
              </div>

              <div class="tree-nodes-container">
                {col.levels.map((row, rowIndex) => (
                  <div class="tree-row">
                    {row.map((node) => {
                      const style = getCategoryStyle(node.id);
                      const count = problemSet.filter(p => p.category === node.id).length;
                      
                      return (
                        <div class="tree-node-wrapper">
                          {node.parent && <div class="connector-line"></div>}
                          <div 
                            class="level-card locked" 
                            id={`node-${node.id.replace(/\s+/g, '-')}-${colIndex}`} 
                            data-id={node.id} 
                            data-parent={node.parent}
                          >
                            <div class="icon-ring">
                              <div class="level-icon" style={`background-color: ${style.color}`}>
                                {style.icon}
                              </div>
                              <div class="badge">{count}</div>
                              
                              <div class="lock-overlay">
                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                              </div>
                              <div class="check-overlay">
                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                              </div>
                            </div>
                            <h3>{node.id}</h3>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      </main>

    </div>

    <div id="game-view" style="display: none;">
      <div class="game-nav">
        <button id="nav-back-btn" class="back-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
          Haritaya DÃ¶n
        </button>
        <div style="text-align: right;">
           <h2 id="current-set-title">SET ADI</h2>
           <div id="live-score" style="font-size: 0.9rem; color: #bdc3c7;">Puan: 0</div>
        </div>
      </div>

      <div id="problem-container">
        {problemSet.map((p, index) => (
          <div class="problem-card" data-index={index} data-category={p.category} style="display: none;">
            <div class="header">
              <h3>{p.title}</h3>
              <span class="count-badge">Soru {index + 1}</span>
            </div>
            
            <GoBoard problem={p} isTeacher={false} />
            
            <div class="hint-display" id={`hint-text-${index}`}></div>

            <div class="nav-controls">
              <button class="nav-btn icon-btn prev-btn" title="Ã–nceki" style="visibility: hidden;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
              </button>

              <button class="nav-btn icon-btn hint-btn" title="Ä°pucu">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
              </button>

              <button class="nav-btn icon-btn next-btn" disabled={true} title="Sonraki">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
              </button>

            </div>
          </div>
        ))}
      </div>
    </div>

    <div id="result-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div id="result-icon" class="result-icon">ğŸ†</div>
            <h2 id="result-title">Set TamamlandÄ±!</h2>
            <p id="result-message">Tebrikler, harika iÅŸ Ã§Ä±kardÄ±n.</p>
            <div class="score-display">
                <span id="final-score">0</span> / <span id="total-questions">10</span>
            </div>
            <div class="modal-buttons">
                <button id="back-to-map-btn" class="modal-btn secondary">AÄŸaca DÃ¶n</button>
                <button id="retry-level-btn" class="modal-btn secondary">Tekrar Dene</button>
                <button id="next-level-btn" class="modal-btn success" style="display: none;">Sonraki Seviye â”</button>
            </div>
        </div>
    </div>

  </div>
</Layout>

<script>
  import { supabase } from '../lib/supabase';

  // --- TÄ°P TANIMLAMALARI VE DEÄÄ°ÅKENLER ---
  const levelOrder = [
    "Kurallar", "Esir Alma 1", "Ä°ki GÃ¶z KavramÄ±", "Nefes YarÄ±ÅŸÄ±", "Tesuji 1", "Oyunu Bitirme",
    "Ã–lÃ¼m & KalÄ±m 1", "AÃ§Ä±lÄ±ÅŸ Prensipleri 1", "AÃ§Ä±lÄ±ÅŸ Prensipleri 2", "Sente", "Åekil", "Ko SavaÅŸÄ±", "AÃ§Ä±lÄ±ÅŸ",
    "Joseki", "Ä°stila", "SaldÄ±rÄ±", "Sayma", "Yose", "Dan Seviyesi"
  ];

  const gameSounds: { [key: string]: HTMLAudioElement } = {
      stone: new Audio('/sounds/stone.mp3'),
      correct: new Audio('/sounds/correct.mp3'),
      wrong: new Audio('/sounds/wrong.mp3')
  };
  
  gameSounds.stone.volume = 0.8;
  gameSounds.correct.volume = 0.6;
  gameSounds.wrong.volume = 0.5;

  function playSound(type: string) {
      const sound = gameSounds[type];
      if (sound) {
          sound.currentTime = 0;
          sound.play().catch(e => console.log("Ses hatasÄ±:", e));
      }
  }

  // --- STATE ---
  // HATA Ã‡Ã–ZÃœMÃœ: Dizinin iÃ§inde ne olduÄŸunu belirttik (HTMLElement)
  let activeProblems: HTMLElement[] = []; 
  let currentIndex = 0;
  let currentScore = 0;
  let currentProblemFailed = false;
  let currentCategory = "";
  
  // HATA Ã‡Ã–ZÃœMÃœ: LocalStorage null dÃ¶nebilir, string garantisi verdik
  let completedSets: string[] = JSON.parse(localStorage.getItem('completedSets') || '[]');
  let currentUser: any = null; 

  // --- BAÅLANGIÃ‡ ---
  document.addEventListener('DOMContentLoaded', async () => {
    await initUserProgress(); 
    updateTreeVisuals();      
    attachEventListeners();   
    attachGameListeners();    
  });

  async function initUserProgress() {
    const { data: { user } } = await supabase.auth.getUser();
    currentUser = user;

    if (user) {
        console.log("KullanÄ±cÄ± bulundu, ilerleme senkronize ediliyor...");
        
        const { data } = await supabase
            .from('user_progress')
            .select('category_id')
            .eq('user_id', user.id);

        if (data) {
            const dbSets = data.map((item: any) => item.category_id);
            completedSets = [...new Set([...completedSets, ...dbSets])];
            localStorage.setItem('completedSets', JSON.stringify(completedSets));
        }
    }
  }

  async function saveProgressToCloud(category: string) {
      if (!completedSets.includes(category)) {
          completedSets.push(category);
          localStorage.setItem('completedSets', JSON.stringify(completedSets));
      }

      if (currentUser) {
          const { error } = await supabase
              .from('user_progress')
              .insert({ 
                  user_id: currentUser.id, 
                  category_id: category 
              });
          
          if (error && error.code !== '23505') { 
              console.error("Buluta kayÄ±t hatasÄ±:", error);
          }
      }
  }

  function attachEventListeners() {
      document.querySelectorAll('.level-card').forEach(card => {
          card.addEventListener('click', function(this: HTMLElement) {
              const id = this.getAttribute('data-id') || "";
              const parent = this.getAttribute('data-parent');
              // HATA Ã‡Ã–ZÃœMÃœ: window fonksiyonlarÄ±nÄ± (window as any) ile Ã§aÄŸÄ±rdÄ±k
              (window as any).tryOpenLevel(id, parent, this.id); 
          });
      });

      const backToMapBtn = document.getElementById('back-to-map-btn');
      if(backToMapBtn) backToMapBtn.addEventListener('click', (window as any).goToMap);

      const retryBtn = document.getElementById('retry-level-btn');
      if(retryBtn) retryBtn.addEventListener('click', (window as any).retryLevel);

      const navBackBtn = document.getElementById('nav-back-btn');
      if(navBackBtn) navBackBtn.addEventListener('click', (window as any).goToMap);
      
      const problemContainer = document.getElementById('problem-container');
      if (problemContainer) {
          problemContainer.addEventListener('mousedown', function(e: Event) {
              const target = e.target as HTMLElement;
              // HATA Ã‡Ã–ZÃœMÃœ: e.target null olabilir, kontrol ettik
              if (target && !target.closest('button')) {
                  playSound('stone');
              }
          });
      }
  }

  function attachGameListeners() {
      document.addEventListener('click', function(e: Event) {
          const target = e.target as HTMLElement;
          if (!target) return;

          const btn = target.closest('button');
          if (!btn) return;

          // HATA Ã‡Ã–ZÃœMÃœ: FonksiyonlarÄ± window Ã¼zerinden Ã§aÄŸÄ±rdÄ±k
          if (btn.classList.contains('prev-btn')) (window as any).navigate(-1);
          else if (btn.classList.contains('hint-btn')) (window as any).showHint(currentIndex);
          else if (btn.classList.contains('next-btn') && !btn.disabled) (window as any).navigate(1);
      });
  }

  function updateTreeVisuals() {
    const cards = document.querySelectorAll('.level-card');
    cards.forEach(card => {
        const id = card.getAttribute('data-id') || "";
        const parent = card.getAttribute('data-parent');
        
        card.classList.remove('locked', 'unlocked', 'completed');
        
        if (completedSets.includes(id)) {
            card.classList.add('completed');
        } else if (parent === 'null' || parent === null || completedSets.includes(parent)) {
            card.classList.add('unlocked');
        } else {
            card.classList.add('locked');
        }
    });
  }

  // --- WINDOW FONKSÄ°YONLARI ---
  // HATA Ã‡Ã–ZÃœMÃœ: TypeScript'te window'a yeni Ã¶zellik eklemek iÃ§in (window as any) kullanÄ±lÄ±r.
  
  (window as any).tryOpenLevel = function(category: string, parent: string | null, elementId: string) {
      const isUnlocked = parent === 'null' || parent === null || completedSets.includes(parent);
      if (isUnlocked) {
          (window as any).openLevel(category);
      } else {
          const card = document.getElementById(elementId);
          if(card) {
              playSound('wrong');
              card.classList.add('shake-lock');
              setTimeout(() => card.classList.remove('shake-lock'), 500);
          }
      }
  };

  (window as any).openLevel = function(category: string) {
    currentCategory = category;
    
    // HATA Ã‡Ã–ZÃœMÃœ: Null check (?) ekledik
    document.getElementById('level-map')!.style.display = 'none';
    document.getElementById('game-view')!.style.display = 'block';
    
    const titleEl = document.getElementById('current-set-title');
    if(titleEl) titleEl.innerText = category.toUpperCase();
    
    currentScore = 0;
    const scoreEl = document.getElementById('live-score');
    if(scoreEl) scoreEl.innerText = `Puan: 0`;
    
    (window as any).filterSet(category);
  };

  (window as any).goToMap = function() {
    document.getElementById('result-modal')!.style.display = 'none';
    document.getElementById('game-view')!.style.display = 'none';
    document.getElementById('level-map')!.style.display = 'grid'; 
    updateTreeVisuals(); 
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  (window as any).retryLevel = function() {
      document.getElementById('result-modal')!.style.display = 'none';
      (window as any).openLevel(currentCategory);
  };

  (window as any).handleMoveResult = function(isCorrect: boolean) {
      if (isCorrect) {
          setTimeout(() => playSound('correct'), 400);
      } else {
          currentProblemFailed = true;
          setTimeout(() => playSound('wrong'), 400);
      }
  };

  (window as any).filterSet = function(category: string) {
    // HATA Ã‡Ã–ZÃœMÃœ: NodeList'i Array'e Ã§evirirken tÃ¼r belirttik
    const allCards = Array.from(document.querySelectorAll('.problem-card')) as HTMLElement[];
    activeProblems = allCards.filter(card => card.getAttribute('data-category') === category);

    if (activeProblems.length === 0) {
        alert(`"${category}" seti boÅŸ!`);
        (window as any).goToMap(); 
        return;
    }
    
    currentIndex = 0;
    currentProblemFailed = false;
    
    activeProblems.forEach((card, idx) => {
        const countBadge = card.querySelector('.count-badge') as HTMLElement;
        if(countBadge) countBadge.innerText = `Soru ${idx + 1} / ${activeProblems.length}`;
        
        const nextBtn = card.querySelector('.next-btn') as HTMLButtonElement;
        if(nextBtn) {
            nextBtn.disabled = true; 
            nextBtn.style.opacity = "0.5"; 
            nextBtn.classList.remove('glow-animation'); 
            nextBtn.innerHTML = idx === activeProblems.length - 1 
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>` 
                : `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`;
        }
    });
    updateView();
  };

  function updateView() {
    // HATA Ã‡Ã–ZÃœMÃœ: activeProblems artÄ±k HTMLElement[] olduÄŸu iÃ§in .style var
    document.querySelectorAll('.problem-card').forEach((c) => (c as HTMLElement).style.display = 'none');
    
    const currentCard = activeProblems[currentIndex];
    if (currentCard) currentCard.style.display = 'block';

    document.querySelectorAll('.hint-display').forEach((h) => { 
        (h as HTMLElement).style.opacity = '0'; 
        h.innerHTML = ''; 
    });
  }

  (window as any).navigate = function(direction: number) {
    const newIndex = currentIndex + direction;
    if (!currentProblemFailed && direction === 1) {
        currentScore++;
        const scoreEl = document.getElementById('live-score');
        if(scoreEl) scoreEl.innerText = `Puan: ${currentScore}`;
    }
    if (currentIndex === activeProblems.length - 1 && direction === 1) {
        (window as any).showResults(); 
        return;
    }
    if (newIndex >= 0 && newIndex < activeProblems.length) {
      currentIndex = newIndex; 
      currentProblemFailed = false; 
      updateView();
    }
  };

  (window as any).showResults = function() {
      const modal = document.getElementById('result-modal');
      const title = document.getElementById('result-title');
      const message = document.getElementById('result-message');
      const icon = document.getElementById('result-icon');
      const nextBtn = document.getElementById('next-level-btn');
      
      const total = activeProblems.length;
      
      const finalScoreEl = document.getElementById('final-score');
      if(finalScoreEl) finalScoreEl.innerText = String(currentScore);

      const totalQEl = document.getElementById('total-questions');
      if(totalQEl) totalQEl.innerText = String(total);
      
      const successThreshold = Math.ceil(total * 0.8);

      if (modal && title && message && icon && nextBtn) {
          if (currentScore >= successThreshold) {
              playSound('correct'); 
              title.innerText = "Set TamamlandÄ±!";
              title.style.color = "#2ecc71";
              message.innerText = "Tebrikler! Bir sonraki seviye aÃ§Ä±ldÄ±.";
              icon.innerText = "ğŸ†";
              
              saveProgressToCloud(currentCategory);

              const currentPos = levelOrder.indexOf(currentCategory);
              if (currentPos !== -1 && currentPos < levelOrder.length - 1) {
                  const nextLevelID = levelOrder[currentPos + 1];
                  nextBtn.style.display = "inline-block"; 
                  nextBtn.onclick = function() {
                      modal.style.display = 'none';
                      (window as any).openLevel(nextLevelID);
                  };
              } else {
                  nextBtn.style.display = "none";
              }
          } else {
              playSound('wrong');
              title.innerText = "BaÅŸarÄ±sÄ±z";
              title.style.color = "#e74c3c";
              message.innerText = `GeÃ§mek iÃ§in en az ${successThreshold} doÄŸru yapmalÄ±sÄ±n.`;
              icon.innerText = "âŒ";
              nextBtn.style.display = "none";
          }
          modal.style.display = 'flex';
      }
  };

  (window as any).showHint = function(index: number) {
    const currentCard = activeProblems[currentIndex];
    const hintDiv = currentCard.querySelector('.hint-display') as HTMLElement;
    if (hintDiv) {
        if (hintDiv.style.opacity === "1") { 
            hintDiv.style.opacity = "0"; 
            setTimeout(() => { hintDiv.innerHTML = ""; }, 300); 
        } else { 
            hintDiv.innerHTML = `<span class="hint-icon">ğŸ’¡</span> <strong>Ä°pucu:</strong> Hamleni yapmadan Ã¶nce 2 adÄ±m sonrasÄ±nÄ± dÃ¼ÅŸÃ¼n.`; 
            hintDiv.style.opacity = "1"; 
        }
    }
  };

  (window as any).unlockNextButton = function() {
    const currentCard = activeProblems[currentIndex];
    if (currentCard) {
      const nextBtn = currentCard.querySelector('.next-btn') as HTMLButtonElement;
      if (nextBtn) {
        nextBtn.disabled = false; 
        nextBtn.style.opacity = "1"; 
        nextBtn.style.cursor = "pointer"; 
        nextBtn.classList.add('glow-animation');
      }
    }
  };
</script>

<style>
  /* --- TEMA AYARLARI --- */
  :root {
    /* VARSAYILAN (KOYU MOD) */
    --text-main: #2c3e50;
    --text-sub: #7f8c8d;
    --card-bg-hover: rgba(255,255,255,0.1);
    --sidebar-bg: rgba(255,255,255,0.05);
    --sidebar-border: rgba(255,255,255,0.1);
    --btn-bg: #2c3e50;
    --btn-border: #34495e;
    --shadow-color: rgba(0,0,0,0.5);
  }

  /* AÃ‡IK MOD (Light Mode) */
  :global(body.light), :global(html.light) {
    --text-main: #000000; /* SÄ°YAH / LACÄ°VERT YAZI */
    --text-sub: #555555;  /* KOYU GRÄ° YAZI */
    --card-bg-hover: rgba(0,0,0,0.05);
    --sidebar-bg: #f8f9fa;
    --sidebar-border: rgba(0,0,0,0.1);
    --shadow-color: rgba(0,0,0,0.1);
  }

  .page-wrapper {
    max-width: 1400px; margin: 0 auto; padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: var(--text-main); /* Ana metin rengi */
  }
  
  /* BaÅŸlÄ±klar */
  .main-title { 
    font-size: 2.5rem; 
    color: var(--text-main); 
    margin-bottom: 5px; 
    text-align: center; 
  }
  .subtitle { 
    color: var(--text-sub); 
    font-size: 1.1rem; 
    margin-bottom: 40px; 
    text-align: center; 
  }
  /* GRID */
  .content-grid { display: grid; grid-template-columns: 280px 1fr; gap: 40px; align-items: start; }

  /* SIDEBAR */
  .sidebar { 
    background: var(--sidebar-bg); 
    border: 1px solid var(--sidebar-border); 
    border-radius: 15px; padding: 20px; position: sticky; top: 20px; backdrop-filter: blur(10px); 
  }
  .sidebar-header h3 { 
    color: var(--text-main); 
    border-bottom: 1px solid var(--sidebar-border); 
  }
  
  .course-group { margin-bottom: 25px; }
  .course-group h4 { 
    color: var(--text-main); /* Daha belirgin olmasÄ± iÃ§in main yapÄ±ldÄ± */
    opacity: 0.8;
  }
  .course-group ul { list-style: none; padding: 0; margin: 0; }
  .course-group li { 
    color: var(--text-sub); 
  }
  .dot { width: 6px; height: 6px; background: rgba(127, 140, 141, 0.5); border-radius: 50%; }

  :root { --beginner-color: #3498db; --intermediate-color: #f1c40f; --advanced-color: #e74c3c; }

  .columns-container { display: flex; justify-content: space-between; gap: 30px; }
  .tree-column { flex: 1; background: transparent; padding: 10px; display: flex; flex-direction: column; align-items: center; }
  .column-header h2 { 
    color: var(--text-main); 
  }
  .header-line { width: 60px; height: 4px; margin: 0 auto 50px auto; border-radius: 2px; }
  .tree-column.beginner .header-line { background: #3498db; }
  .tree-column.intermediate .header-line { background: #f1c40f; }
  .tree-column.advanced .header-line { background: #e74c3c; }

  .tree-nodes-container { display: flex; flex-direction: column; gap: 70px; width: 100%; }
  .tree-row { display: flex; justify-content: center; width: 100%; position: relative; }
  .tree-node-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; }
  .connector-line { position: absolute; top: -75px; left: 50%; width: 3px; height: 75px; background-color: rgba(127, 140, 141, 0.3); transform: translateX(-50%); z-index: 0; }

  .level-card h3 { 
    color: var(--text-main); 
  }
  .icon-ring { width: 100px; height: 100px; border-radius: 50%; background-color: #ecf0f1; border: 5px solid #bdc3c7; display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 15px; box-shadow: 0 5px 15px var(--shadow-color); transition: all 0.3s; }
  .level-icon { width: 75px; height: 75px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; color: white; }
  .badge { position: absolute; top: 0; right: 0; background: #34495e; color: white; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; border: 2px solid #fff; }
  
  .level-card h3 { color: var(--text-main); margin: 0; font-size: 1rem; font-weight: 600; }

  .level-card.locked { opacity: 0.7; cursor: not-allowed; }
  .level-card.locked .icon-ring { border-color: #7f8c8d; background-color: #95a5a6; }
  .level-card.locked .level-icon { background-color: #7f8188 !important; filter: grayscale(100%); }
  .level-card.locked .lock-overlay { display: flex; }
  .level-card.locked .check-overlay { display: none; }
  
  .level-card.unlocked .icon-ring { border-color: #f1c40f; }
  .level-card.unlocked .lock-overlay { display: none; }
  .level-card.unlocked .check-overlay { display: none; }
  .level-card.unlocked:hover { transform: scale(1.1); }
  
  .level-card.completed .icon-ring { border-color: #2ecc71; box-shadow: 0 0 15px rgba(46, 204, 113, 0.4); }
  .level-card.completed .lock-overlay { display: none; }
  .level-card.completed .check-overlay { display: flex; }

  .lock-overlay, .check-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); }
  .check-overlay { background: rgba(0,0,0,0); }
  .shake-lock { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
  @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

  /* --- OYUN ALANI --- */
  .game-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--sidebar-border); color: var(--text-main); }
 .game-nav h2, .header h3 { 
    color: var(--text-main); 
  }
  .back-btn { background: var(--sidebar-bg); border: 1px solid var(--sidebar-border); color: var(--text-main); padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
  .back-btn:hover { background: var(--card-bg-hover); transform: translateX(-3px); }
  
  .problem-card { background: transparent; border: none; box-shadow: none; padding: 10px 0; margin-bottom: 20px; text-align: center; }
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .header h3 { margin: 0; font-size: 1.5rem; color: var(--text-main); }
  .count-badge {
    background: var(--sidebar-bg);
    color: var(--text-sub);
    border: 1px solid var(--sidebar-border);
  }
   .hint-display { margin-top: 15px; background-color: #fff3cd; padding: 10px; border-radius: 8px; opacity: 0; transition: opacity 0.3s; color: #333; }
  
 /* --- BUTONLAR: GÃœNCELLENMÄ°Å HÄ°BRÄ°T YAPI --- */
  .nav-controls { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
  
  .nav-btn.icon-btn { 
    width: 55px; height: 55px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    
    /* VARSAYILAN (KOYU MOD) */
    background-color: var(--btn-bg, #2c3e50);
    border: 2px solid var(--btn-border, #34495e);
    color: white; 
  }

  /* --- AÃ‡IK MOD (LIGHT MODE) Ã–ZEL AYARI --- */
  /* Sayfa aÃ§Ä±k renk olsa bile, bu butonlarÄ± zÄ±tlÄ±k (kontrast) iÃ§in KOYU tutuyoruz */
  :global(body.light) .nav-btn.icon-btn {
    background-color: #2c3e50 !important; /* Sabit Koyu Lacivert */
    border-color: #1a252f !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.25) !important; /* GÃ¶lgeyi belirginleÅŸtir */
  }

  /* Hover Efekti (Her iki modda da Ã§alÄ±ÅŸÄ±r) */
  .nav-btn.icon-btn:not(:disabled):hover { 
    background-color: #1a252f !important; /* Daha koyu ton */
    transform: scale(1.1); 
    border-color: #5d6d7e !important;
  }
  
  /* Disabled Durumu */
  .nav-btn.icon-btn:disabled { 
    opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; 
    background-color: #95a5a6 !important; /* Gri */
    border-color: transparent !important;
    color: #ecf0f1 !important;
  }
  
  /* --- Ä°KON RENKLERÄ° --- */
  /* Koyu buton Ã¼zerinde gÃ¶rÃ¼necek renkler */
  
  .prev-btn { color: #bdc3c7; } 
  /* AÃ§Ä±k modda buton koyu olduÄŸu iÃ§in ikonun iyice parlamasÄ± lazÄ±m */
  :global(body.light) .prev-btn { color: #ecf0f1 !important; }

  .hint-btn { color: #f1c40f; border-color: rgba(241, 196, 15, 0.5); }
  :global(body.light) .hint-btn { color: #f1c40f !important; border-color: #f39c12 !important; }

  .next-btn { color: #3498db; border-color: rgba(52, 152, 219, 0.5); }
  :global(body.light) .next-btn { color: #5dade2 !important; border-color: #2980b9 !important; }

  .glow-animation { animation: pulse-green 2s infinite; }
  @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(46, 204, 113, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); } }
  
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
  .modal-content { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .result-icon { font-size: 4rem; margin-bottom: 10px; }
  .score-display { font-size: 2.5rem; font-weight: bold; color: #2c3e50; margin: 20px 0; }
  .modal-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
  .modal-btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 1rem; }
  .modal-btn.primary { background: #3498db; color: white; }
  .modal-btn.secondary { background: #ecf0f1; color: #7f8c8d; }
  .modal-btn:hover { transform: translateY(-2px); }

  /* YeÅŸil "Sonraki Seviye" Butonu */
  .modal-btn.success {
    background-color: #2ecc71; /* CanlÄ± YeÅŸil */
    color: white;
    border: 2px solid #27ae60;
    box-shadow: 0 4px 6px rgba(46, 204, 113, 0.3);
  }

  .modal-btn.success:hover {
    background-color: #27ae60;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(46, 204, 113, 0.4);
  }

  /* --- AÃ‡IK MOD Ä°Ã‡Ä°N AÄAÃ‡ GÃ–RÃœNÃœMÃœ DÃœZELTMESÄ° (GRÄ°LÄ°K GÄ°DERME) --- */
  :global(body.light) .level-card.locked {
    opacity: 0.5;
  }
  :global(body.light) .level-card.locked .icon-ring {
    background-color: #f0f0f0; 
    border-color: #e0e0e0;     
    box-shadow: none;          
  }
  :global(body.light) .level-card.locked .level-icon {
    background-color: #d1d1d1 !important; 
    filter: grayscale(80%) brightness(1.2); 
  }
  :global(body.light) .lock-overlay svg {
    stroke: #7f8c8d; /* Beyaz kilit aÃ§Ä±k zeminde gÃ¶rÃ¼nmez, gri yapÄ±yoruz */
  }
  :global(body.light) .connector-line {
    background-color: rgba(0, 0, 0, 0.1); 
  }

  @media (max-width: 900px) {
    .content-grid { grid-template-columns: 1fr; }
    .sidebar { position: relative; top: 0; margin-bottom: 40px; }
    .columns-container { flex-direction: column; }
    
  }
  /* Style kÄ±smÄ±nda bu sÄ±nÄ±fÄ± bul ve gap ekle */
  .tree-row { 
      display: flex; 
      justify-content: center; 
      width: 100%; 
      position: relative; 
      gap: 30px; /* EKLENDÄ°: Yan yana gelen kutular arasÄ±na boÅŸluk koyar */
  }
</style>