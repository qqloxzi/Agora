---
import { supabase } from "../../lib/supabase";


// Admin Kontrolü (Senin emailin)
const ADMIN_EMAIL = "alikarakayagg@gmail.com"; 
const { data: { user } } = await supabase.auth.getUser();

if (!user || user.email !== ADMIN_EMAIL) return Astro.redirect("/");
---

<div class="max-w-2xl mx-auto mt-10 p-8 bg-white border rounded-xl shadow-sm">
  <h1 class="text-2xl font-bold mb-6 text-gray-800">Yeni Kurs Ekle</h1>
  
  <form id="create-course-form" class="flex flex-col gap-5">
    
    <label class="block">
      <span class="text-gray-700 font-semibold">Kurs Başlığı</span>
      <input type="text" name="title" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Örn: Go Oyununa Giriş" />
    </label>

    <label class="block">
      <span class="text-gray-700 font-semibold">Kapak Resmi (URL)</span>
      <input type="url" name="image_url" required class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="https://ornek.com/resim.jpg" />
      <p class="text-xs text-gray-500 mt-1">Kare veya yatay bir görsel linki yapıştır.</p>
    </label>

    <label class="block">
      <span class="text-gray-700 font-semibold">Sağlayıcı / Eğitmen</span>
      <input type="text" name="provider" value="Agora Go" class="mt-1 block w-full border border-gray-300 rounded-md p-2" />
    </label>

    <label class="block">
      <span class="text-gray-700 font-semibold">Açıklama</span>
      <textarea name="description" required rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2"></textarea>
    </label>

    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-md transition-colors">
      Kursu Yayınla
    </button>
  </form>
  
  <p id="status-msg" class="mt-4 text-center font-medium"></p>
</div>

<script>
  const form = document.getElementById("create-course-form") as HTMLFormElement;
  
  // HATA ÇÖZÜMÜ BURADA: Sonuna 'as HTMLParagraphElement' ekledik
  const msg = document.getElementById("status-msg") as HTMLParagraphElement;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    // Güvenlik önlemi: Eğer element bulunamazsa işlem yapma
    if (!msg || !form) return;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    const res = await fetch("/api/create-course", {
      method: "POST",
      body: JSON.stringify(data),
    });

    if (res.ok) {
      msg.innerText = "✅ Kurs başarıyla oluşturuldu!";
      msg.className = "mt-4 text-center text-green-600 font-bold";
      form.reset();
    } else {
      msg.innerText = "❌ Hata oluştu.";
      msg.className = "mt-4 text-center text-red-600 font-bold";
    }
  });
</script>