---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Hesap Oluştur | Agora Go Akademisi">
  <div class="register-container">
    <div class="register-header">
      <h1>Hesap Oluştur</h1>
    </div>

    <div id="selection-view" class="options-view">
      <button id="show-email-form" class="btn-theme">
        E-posta ile devam et
      </button>
      
      <div class="separator"><span>VEYA</span></div>

      <button id="google-signup" class="btn-theme">
        <img src="https://www.google.com/favicon.ico" alt="Google" class="w-5 h-5" />
        Google ile devam et
      </button>
    </div>

    <div id="email-form-view" class="hidden">
      <div class="register-card">
        <form id="signup-form">
          <div class="input-group">
            <label for="email">E-posta</label>
            <input type="email" id="email" placeholder="E-posta adresinizi girin" required />
          </div>

          <div class="input-group">
            <label for="password">Şifre</label>
            <input type="password" id="password" placeholder="Şifrenizi belirleyin" required />
          </div>

          <div class="input-group">
            <label for="username">Kullanıcı Adı</label>
            <input type="text" id="username" placeholder="Sitede görünecek adınız" required />
          </div>


          <button type="submit" class="submit-btn">Hesap Oluştur</button>
        </form>
        <button id="back-to-selection" class="back-link">← Seçeneklere Geri Dön</button>
      </div>
    </div>
    
    <p id="message"></p>
  </div>

  <style>
    .register-container { max-width: 420px; margin: 5rem auto; padding: 0 1rem; font-family: 'Inter', sans-serif; }
    .register-header h1 { font-size: 2rem; text-align: left; margin-bottom: 2.5rem; color: #1a1a1a; font-weight: 700; }
    
    /* Navbardaki "Kayıt Ol" Butonu Teması (Koyu Lacivert) */
    .btn-theme, .submit-btn {
      width: 100%; 
      padding: 0.85rem; 
      border: none; 
      border-radius: 9999px; /* Tam yuvarlak */
      background: #1e293b; /* Koyu lacivert/slate tonu */
      color: white; 
      font-size: 0.95rem; 
      font-weight: 600; 
      cursor: pointer;
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 12px;
      transition: opacity 0.2s, transform 0.1s;
      margin-bottom: 0.75rem;
    }
    .btn-theme:hover, .submit-btn:hover { opacity: 0.9; }
    .btn-theme:active, .submit-btn:active { transform: scale(0.97); }

    .separator { text-align: center; margin: 1.5rem 0; border-bottom: 1px solid #d1d5db; line-height: 0.1em; }
    .separator span { background: #DFE1E5; padding: 0 15px; color: #6b7280; font-size: 0.7rem; font-weight: bold; }

    .hidden { display: none; }
    .input-group { margin-bottom: 1.2rem; }
    label { display: block; margin-bottom: 0.4rem; font-size: 0.85rem; font-weight: 600; color: #334155; }
    input, select { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 0.95rem; }

    .back-link { background: none; border: none; color: #64748b; margin-top: 1.5rem; cursor: pointer; font-size: 0.85rem; width: 100%; text-decoration: underline; }

    #message { margin-top: 1.2rem; text-align: center; font-size: 0.9rem; font-weight: 500; }
    .w-5 { width: 1.25rem; }
    .h-5 { height: 1.25rem; }
  </style>

  <script>
    import { supabase } from '../lib/supabase';

    const selectionView = document.getElementById('selection-view');
    const emailFormView = document.getElementById('email-form-view');
    const showEmailBtn = document.getElementById('show-email-form');
    const backBtn = document.getElementById('back-to-selection');
    const signupForm = document.getElementById('signup-form') as HTMLFormElement | null;
    const messageBox = document.getElementById('message');

    showEmailBtn?.addEventListener('click', () => {
      selectionView?.classList.add('hidden');
      emailFormView?.classList.remove('hidden');
    });

    backBtn?.addEventListener('click', () => {
      emailFormView?.classList.add('hidden');
      selectionView?.classList.remove('hidden');
    });

    signupForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = (document.getElementById('email') as HTMLInputElement).value;
      const password = (document.getElementById('password') as HTMLInputElement).value;

      if (!messageBox) return;
      messageBox.textContent = "Hesabınız oluşturuluyor...";

      const { error } = await supabase.auth.signUp({ email, password });

      if (error) {
        messageBox.textContent = "Hata: " + error.message;
        messageBox.style.color = "#ef4444";
      } else {
        messageBox.textContent = "Başarılı! Lütfen e-postanızı onaylayın.";
        messageBox.style.color = "#10b981";
      }
    });

    document.getElementById('google-signup')?.addEventListener('click', async () => {
      if (messageBox) {
        messageBox.textContent = "Google ile bağlanılıyor...";
        messageBox.style.color = "#1e293b";
      }

      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          // ÖNEMLİ: /dashboard sayfası projenizde (src/pages/dashboard.astro) mutlaka var olmalı.
          // Eğer yoksa şimdilik sadece '/' (ana sayfa) yapın.
          redirectTo: window.location.origin + '/dashboard', 
          queryParams: {
            access_type: 'offline',
            prompt: 'consent',
          },
        },
      });

      if (error) {
        if (messageBox) {
          messageBox.textContent = "Giriş hatası: " + error.message;
          messageBox.style.color = "#ef4444";
        }
        console.error("Giriş hatası:", error.message);
      }
    });
  </script>
</Layout>

